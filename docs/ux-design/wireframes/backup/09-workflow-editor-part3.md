# Workflow 編輯器 Wireframe - Part 3: 執行與調試功能

**版本**: 1.0.0 (Part 3/5)
**日期**: 2025-10-29
**狀態**: 🔄 進行中
**複雜度**: ⭐⭐⭐⭐⭐ (極高)

---

## 🎯 執行引擎設計

### 執行模式

```yaml
執行類型:
  Manual Execution (手動執行):
    - 用途: 開發和測試階段
    - 觸發: 用戶點擊「執行」按鈕
    - 特性: 完整調試功能、可暫停、可單步執行

  Scheduled Execution (定時執行):
    - 用途: 定期自動化任務
    - 觸發: Cron 表達式或固定間隔
    - 特性: 後台執行、失敗通知

  Event-Triggered Execution (事件觸發):
    - 用途: 響應外部事件
    - 觸發: Webhook、消息隊列、文件監控
    - 特性: 快速響應、高並發處理

  API-Triggered Execution (API 觸發):
    - 用途: 集成到其他系統
    - 觸發: REST API 調用
    - 特性: 同步/異步模式、參數傳遞
```

### 執行工具欄

```
頂部工具欄 (執行控制):
┌─────────────────────────────────────────────────────────────┐
│ [▶️ 執行] [⏸️ 暫停] [⏹️ 停止] [↪️ 重新執行]                │
│                                                             │
│ 執行模式: ▼ 完整執行                                        │
│   • 完整執行（從頭到尾）                                    │
│   • 從選中節點執行                                          │
│   • 單步執行（調試模式）                                    │
│   • 模擬執行（不實際調用外部 API）                         │
│                                                             │
│ [🐛 調試模式] [⚡ 快速模式] [📊 性能分析]                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔴 實時執行追蹤 UI

### 執行狀態面板（右側面板切換）

```
┌────────────────────────────────────────┐
│ ⚙️ 執行狀態                            │
│ ┌────────────────────────────────────┐ │
│ │ 執行 ID: exec_2025102915230001     │ │
│ │ 狀態: 🔄 執行中                     │ │
│ │ 進度: [=========>        ] 45%     │ │
│ │ 已執行: 6/13 節點                  │ │
│ │ 耗時: 00:02:15 / 預估: 00:05:00    │ │
│ └────────────────────────────────────┘ │
├────────────────────────────────────────┤
│ 📊 執行流程追蹤                        │
│                                        │
│ ✅ Start (node_001)                    │
│    ⏱️ 0.002s • 成功                    │
│                                        │
│ ✅ Input (node_002)                    │
│    ⏱️ 1.234s • 用戶輸入已收集         │
│                                        │
│ ✅ Agent_1 (node_003)                  │
│    ⏱️ 23.456s • 分類完成               │
│    📊 Tokens: 1,234 (input) + 567 (out)│
│                                        │
│ 🔄 Router (node_004)                   │
│    ⏱️ Running... 2.1s                  │
│    🔍 評估路由規則中...                │
│                                        │
│ ⏳ Agent_2 (node_005)                  │
│    等待中...                           │
│                                        │
│ ⏳ Output (node_006)                   │
│    等待中...                           │
│                                        │
│ [🔄 自動刷新] [⬇️ 展開全部]           │
└────────────────────────────────────────┘
```

### 畫布上的視覺反饋

```
節點執行狀態視覺化:

⏳ 等待執行 (灰色)
┌─────────────┐
│ ⏳ Agent_3  │ ← 灰色邊框，圖標灰色
│  等待中...  │
└─────────────┘

🔄 執行中 (藍色 + 動畫)
┌─────────────┐
│ 🔄 Agent_1  │ ← 藍色邊框，脈衝動畫
│ ⚡ 執行中... │   進度環顯示
│ [=====>   ] │
└─────────────┘

✅ 執行成功 (綠色)
┌─────────────┐
│ ✅ Agent_1  │ ← 綠色邊框，打勾圖標
│ ⏱️ 2.3s     │   顯示執行時間
└─────────────┘

❌ 執行失敗 (紅色)
┌─────────────┐
│ ❌ Agent_2  │ ← 紅色邊框，錯誤圖標
│ Error: 500  │   顯示錯誤簡訊
│ [查看詳情]  │   點擊查看完整錯誤
└─────────────┘

⏸️ 已暫停 (黃色)
┌─────────────┐
│ ⏸️ Agent_3  │ ← 黃色邊框，暫停圖標
│ 已暫停      │   可繼續或停止
└─────────────┘

連接線動畫 (數據流動):
節點 A ━━━━➤➤➤━━━➤ 節點 B
      ↑ 藍色粒子流動動畫
        表示數據正在傳輸
```

---

## 🔍 變量檢查器

### 變量檢查面板

```
┌────────────────────────────────────────┐
│ 🔍 變量檢查器                          │
│                                        │
│ 範圍: ▼ 當前節點 (Agent_1)            │
│   • 全局變量                           │
│   • 工作流程變量                       │
│   • 當前節點變量                       │
│   • 輸入/輸出變量                      │
├────────────────────────────────────────┤
│ 🔍 搜尋變量: [_________________]       │
├────────────────────────────────────────┤
│                                        │
│ 📥 輸入變量                            │
│ ┌────────────────────────────────────┐ │
│ │ ▼ userInput (String)               │ │
│ │   "我想查詢訂單狀態"                │ │
│ │   Length: 9 chars                  │ │
│ │   [📋 複製] [👁️ 查看完整]          │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 📤 輸出變量                            │
│ ┌────────────────────────────────────┐ │
│ │ ▼ classification (Object)          │ │
│ │   {                                │ │
│ │     "category": "order_inquiry",   │ │
│ │     "confidence": 0.95,            │ │
│ │     "reasoning": "用戶明確提到..."  │ │
│ │   }                                │ │
│ │   [📋 複製 JSON] [📊 美化顯示]     │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 🧠 內部變量                            │
│ ┌────────────────────────────────────┐ │
│ │ ▶ agent_config (Object)            │ │
│ │ ▶ prompt_template (String)         │ │
│ │ ▶ execution_time (Number) 2.345s   │ │
│ │ ▶ token_usage (Object)             │ │
│ └────────────────────────────────────┘ │
│                                        │
│ [🔄 刷新] [💾 導出全部] [📸 快照]     │
└────────────────────────────────────────┘
```

### 變量監控（Watch）

```
┌────────────────────────────────────────┐
│ 👁️ 監控變量 (Watch)                    │
├────────────────────────────────────────┤
│ [+ 添加監控表達式]                     │
│                                        │
│ 1. userInput                           │
│    ✅ "我想查詢訂單狀態"                │
│    [🗑️]                                │
│                                        │
│ 2. classification.confidence           │
│    ✅ 0.95                              │
│    [🗑️]                                │
│                                        │
│ 3. agent_config.temperature            │
│    ✅ 0.7                               │
│    [🗑️]                                │
│                                        │
│ 4. execution_time > 5                  │
│    ❌ false (2.345s)                   │
│    [🗑️]                                │
│                                        │
│ 💡 提示: 支持 JavaScript 表達式       │
└────────────────────────────────────────┘
```

---

## 🐛 斷點調試功能

### 斷點設置

```
在節點上設置斷點:
┌─────────────┐
│ 🔴 Agent_1  │ ← 左上角紅點表示斷點
│  分類專家   │   點擊設置/移除斷點
└─────────────┘

斷點類型:
  • 常規斷點: 執行前暫停
  • 條件斷點: 條件滿足時暫停
  • 日誌斷點: 不暫停，僅記錄
```

### 斷點管理面板

```
┌────────────────────────────────────────┐
│ 🔴 斷點管理                            │
├────────────────────────────────────────┤
│ [☑ 啟用所有斷點] [🗑️ 清除全部]        │
│                                        │
│ ☑ 斷點 1: Agent_1 (node_003)          │
│    類型: 常規斷點                      │
│    狀態: ⏸️ 已觸發                     │
│    觸發次數: 3                         │
│    [⚙️ 編輯] [🗑️ 刪除] [➡️ 跳到節點] │
│                                        │
│ ☑ 斷點 2: Router (node_004)           │
│    類型: 條件斷點                      │
│    條件: classification.confidence < 0.8│
│    狀態: ⏳ 未觸發                     │
│    [⚙️ 編輯] [🗑️ 刪除]                │
│                                        │
│ ☑ 斷點 3: Output (node_006)           │
│    類型: 日誌斷點                      │
│    日誌: "輸出結果: {{result}}"        │
│    觸發次數: 1                         │
│    [⚙️ 編輯] [🗑️ 刪除]                │
└────────────────────────────────────────┘
```

### 斷點觸發時的 UI

```
觸發斷點時畫布狀態:
┌─────────────┐
│ ⏸️ Agent_1  │ ← 黃色高亮邊框
│ 🔴 斷點觸發 │   顯示「斷點觸發」標籤
│ [繼續] [步進]│   顯示調試控制按鈕
└─────────────┘

調試控制欄:
┌─────────────────────────────────────────────┐
│ ⏸️ 斷點已觸發: Agent_1                      │
│                                             │
│ [▶️ 繼續] [⏭️ 下一步] [⏩ 完成當前節點]     │
│ [⏹️ 停止執行] [🔍 檢查變量]                 │
└─────────────────────────────────────────────┘

單步執行模式:
  • 下一步 (Next): 執行下一個節點
  • 步入 (Step Into): 如果是子流程，進入查看
  • 步出 (Step Out): 完成當前節點，返回
  • 繼續 (Continue): 執行到下一個斷點或完成
```

---

## 📋 執行日誌面板

### 日誌面板設計

```
┌────────────────────────────────────────────────────────────┐
│ 📋 執行日誌                                                │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ [全部] [Info] [Warning] [Error] [Debug]               │ │
│ │ 🔍 搜尋日誌: [_____________________] [🔄] [🗑️ 清除]  │ │
│ └────────────────────────────────────────────────────────┘ │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ 15:23:01.234 [INFO] Start (node_001)                      │
│   ✅ 工作流程開始執行                                      │
│   Execution ID: exec_2025102915230001                     │
│                                                            │
│ 15:23:01.256 [INFO] Input (node_002)                      │
│   📥 等待用戶輸入...                                       │
│                                                            │
│ 15:23:03.489 [INFO] Input (node_002)                      │
│   ✅ 收到用戶輸入: "我想查詢訂單狀態"                      │
│   Input size: 9 chars                                     │
│   [▶ 展開數據] [📋 複製]                                  │
│                                                            │
│ 15:23:03.502 [INFO] Agent_1 (node_003)                    │
│   🤖 開始執行 Agent: 分類專家                              │
│   Model: GPT-4, Temperature: 0.7                          │
│                                                            │
│ 15:23:26.958 [INFO] Agent_1 (node_003)                    │
│   ✅ Agent 執行完成                                        │
│   Duration: 23.456s                                       │
│   Tokens: 1,234 (input) + 567 (output) = 1,801 total     │
│   Cost: $0.0234                                           │
│   Result: {"category": "order_inquiry", ...}              │
│   [▶ 查看完整響應] [📊 性能分析]                          │
│                                                            │
│ 15:23:27.102 [WARNING] Router (node_004)                  │
│   ⚠️ 路由規則匹配到多個分支，使用優先級選擇                │
│   Matched: route_1 (priority: 1), route_3 (priority: 3)  │
│   Selected: route_1                                       │
│   [📖 查看路由邏輯]                                       │
│                                                            │
│ 15:23:27.150 [ERROR] Agent_2 (node_005)                   │
│   ❌ Agent 執行失敗                                        │
│   Error: API timeout after 30s                            │
│   Retry: 1/3 attempts                                     │
│   [▶ 查看錯誤堆疊] [🔄 重試]                              │
│                                                            │
│ 15:23:59.234 [ERROR] Agent_2 (node_005)                   │
│   ❌ Agent 執行失敗 (最終)                                 │
│   Error: Connection timeout (30s)                         │
│   Retries exhausted: 3/3 attempts                         │
│   Workflow terminated with error                          │
│   [📊 查看完整錯誤報告]                                   │
│                                                            │
├────────────────────────────────────────────────────────────┤
│ 顯示 1-8 / 共 156 條日誌                                   │
│ [◀ 上一頁] [1] [2] [3] ... [20] [下一頁 ▶]               │
│ [💾 導出日誌] [📊 生成報告] [🔍 高級篩選]                 │
└────────────────────────────────────────────────────────────┘
```

### 日誌等級顏色編碼

```yaml
日誌等級視覺:
  DEBUG (調試):
    顏色: #9CA3AF (灰色)
    圖標: 🔧
    用途: 開發調試信息

  INFO (信息):
    顏色: #3B82F6 (藍色)
    圖標: ℹ️
    用途: 一般執行信息

  WARNING (警告):
    顏色: #F59E0B (橙色)
    圖標: ⚠️
    用途: 潛在問題提示

  ERROR (錯誤):
    顏色: #EF4444 (紅色)
    圖標: ❌
    用途: 執行錯誤

  SUCCESS (成功):
    顏色: #10B981 (綠色)
    圖標: ✅
    用途: 成功完成標記
```

---

## 🚨 錯誤堆疊追蹤

### 錯誤詳情彈窗

```
┌──────────────────────────────────────────────────────────┐
│ ❌ 節點執行錯誤詳情                                 [✕]  │
├──────────────────────────────────────────────────────────┤
│ 節點: Agent_2 (node_005)                                 │
│ 類型: agent_single                                       │
│ 執行 ID: exec_2025102915230001                           │
│ 時間: 2025-10-29 15:23:59.234                           │
├──────────────────────────────────────────────────────────┤
│ 📋 錯誤信息                                              │
│ ┌────────────────────────────────────────────────────┐   │
│ │ Error: Connection timeout after 30s                │   │
│ │ Code: ETIMEDOUT                                    │   │
│ │ HTTP Status: N/A                                   │   │
│ └────────────────────────────────────────────────────┘   │
│                                                          │
│ 🔍 錯誤堆疊                                              │
│ ┌────────────────────────────────────────────────────┐   │
│ │ at AgentExecutor.execute (agent-executor.ts:145)   │   │
│ │ at async WorkflowEngine.executeNode (engine.ts:89) │   │
│ │ at async WorkflowEngine.run (engine.ts:45)         │   │
│ │ at async executeWorkflow (api/workflows.ts:234)    │   │
│ └────────────────────────────────────────────────────┘   │
│                                                          │
│ 📊 執行上下文                                            │
│ ┌────────────────────────────────────────────────────┐   │
│ │ Agent ID: agent_processing_expert                  │   │
│ │ Model: GPT-4                                       │   │
│ │ Input Tokens: 1,523                                │   │
│ │ Timeout Setting: 30s                               │   │
│ │ Retry Attempts: 3/3 (exhausted)                    │   │
│ │                                                    │   │
│ │ Input Data:                                        │   │
│ │ {                                                  │   │
│ │   "category": "order_inquiry",                     │   │
│ │   "confidence": 0.95,                              │   │
│ │   "userInput": "我想查詢訂單狀態"                   │   │
│ │ }                                                  │   │
│ └────────────────────────────────────────────────────┘   │
│                                                          │
│ 💡 建議解決方案                                          │
│ ┌────────────────────────────────────────────────────┐   │
│ │ 1. 檢查 Agent API 連接狀態                         │   │
│ │ 2. 增加超時時間設定（目前 30s）                    │   │
│ │ 3. 檢查網絡連接和防火牆設定                        │   │
│ │ 4. 查看 Agent 服務健康狀態                         │   │
│ └────────────────────────────────────────────────────┘   │
│                                                          │
│ [🔄 重試執行] [📋 複製錯誤] [💾 導出報告] [關閉]        │
└──────────────────────────────────────────────────────────┘
```

### 錯誤統計面板

```
┌────────────────────────────────────────┐
│ 📊 執行錯誤統計                        │
├────────────────────────────────────────┤
│ 總執行次數: 1,234                      │
│ 成功執行: 1,045 (84.7%)                │
│ 失敗執行: 189 (15.3%)                  │
│                                        │
│ 📈 錯誤趨勢 (最近 7 天)                │
│ ┌────────────────────────────────────┐ │
│ │    ▂▃▅▆█▆▅▃                        │ │
│ │ Mon Tue Wed Thu Fri Sat Sun        │ │
│ └────────────────────────────────────┘ │
│                                        │
│ 🔝 Top 錯誤類型                        │
│ 1. Connection Timeout: 78 次 (41%)    │
│ 2. API Rate Limit: 45 次 (24%)        │
│ 3. Invalid Input: 32 次 (17%)         │
│ 4. Agent Not Found: 21 次 (11%)       │
│ 5. 其他: 13 次 (7%)                    │
│                                        │
│ [📊 查看詳細報告]                      │
└────────────────────────────────────────┘
```

---

## ⚡ 性能分析工具

### 性能分析面板

```
┌─────────────────────────────────────────────────────────┐
│ ⚡ 性能分析                                             │
├─────────────────────────────────────────────────────────┤
│ 執行 ID: exec_2025102915230001                          │
│ 總耗時: 00:05:32.456 ⏱️                                │
│                                                         │
│ 📊 節點執行時間分佈                                     │
│ ┌───────────────────────────────────────────────────┐   │
│ │                                                   │   │
│ │ Agent_1     ████████████████████ 23.456s (42%)   │   │
│ │ Agent_2     ████████████████ 18.234s (33%)       │   │
│ │ Router      ██ 2.150s (4%)                        │   │
│ │ Database    ████████ 8.456s (15%)                │   │
│ │ Output      ██ 1.234s (2%)                        │   │
│ │ 其他        ██ 2.926s (4%)                        │   │
│ │                                                   │   │
│ └───────────────────────────────────────────────────┘   │
│                                                         │
│ 🐢 性能瓶頸 Top 3                                       │
│ ┌───────────────────────────────────────────────────┐   │
│ │ 1. Agent_1 (node_003) - 23.456s                   │   │
│ │    • Model 響應時間過長                           │   │
│ │    • 建議: 優化提示詞或降低 Temperature           │   │
│ │    [⚙️ 優化建議]                                   │   │
│ │                                                   │   │
│ │ 2. Agent_2 (node_005) - 18.234s                   │   │
│ │    • 大量輸入 Token (2,345)                       │   │
│ │    • 建議: 精簡輸入內容或使用更快的 Model         │   │
│ │    [⚙️ 優化建議]                                   │   │
│ │                                                   │   │
│ │ 3. Database (node_007) - 8.456s                   │   │
│ │    • 複雜查詢執行時間過長                         │   │
│ │    • 建議: 添加索引或優化 SQL                     │   │
│ │    [⚙️ 優化建議]                                   │   │
│ └───────────────────────────────────────────────────┘   │
│                                                         │
│ 💰 成本分析                                             │
│ ┌───────────────────────────────────────────────────┐   │
│ │ Agent_1 (GPT-4):                                  │   │
│ │   Input: 1,234 tokens × $0.03/1K = $0.0370       │   │
│ │   Output: 567 tokens × $0.06/1K = $0.0340        │   │
│ │   Subtotal: $0.0710                               │   │
│ │                                                   │   │
│ │ Agent_2 (GPT-4):                                  │   │
│ │   Input: 2,345 tokens × $0.03/1K = $0.0704       │   │
│ │   Output: 891 tokens × $0.06/1K = $0.0535        │   │
│ │   Subtotal: $0.1239                               │   │
│ │                                                   │   │
│ │ 總成本: $0.1949 (單次執行)                        │   │
│ │ 預估月成本: $584.70 (3,000 次/月)                 │   │
│ └───────────────────────────────────────────────────┘   │
│                                                         │
│ 🔄 並行執行機會                                         │
│ ┌───────────────────────────────────────────────────┐   │
│ │ 檢測到 2 個節點可並行執行:                        │   │
│ │ • Agent_3 (node_008) 和 Agent_4 (node_009)        │   │
│ │ 預計節省時間: ~15s (27%)                          │   │
│ │ [🚀 優化流程結構]                                 │   │
│ └───────────────────────────────────────────────────┘   │
│                                                         │
│ [💾 導出報告] [📊 對比歷史執行] [🔍 詳細分析]         │
└─────────────────────────────────────────────────────────┘
```

### 性能時間軸視圖

```
┌─────────────────────────────────────────────────────────┐
│ ⏱️ 執行時間軸                                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 0s        10s       20s       30s       40s       50s   │
│ ├─────────┼─────────┼─────────┼─────────┼─────────┤    │
│ │                                                       │
│ Start ▓                                                 │
│ Input ░▓                                                │
│ Agent_1  ░░░░░░░░░░░░░░░░░░░░▓                         │
│ Router                        ░▓                        │
│ Agent_2                         ░░░░░░░░░░░░░░░▓        │
│ Database                                        ░░░░▓   │
│ Output                                              ░▓  │
│ End                                                  ▓  │
│                                                         │
│ ▓ 執行中  ░ 等待/空閒                                   │
│                                                         │
│ 點擊節點查看詳細時間資訊                                │
└─────────────────────────────────────────────────────────┘
```

---

## 🎮 調試控制快捷鍵

```yaml
快捷鍵映射:

執行控制:
  F5: 開始執行 / 繼續執行
  F6: 暫停執行
  Shift + F5: 停止執行
  Ctrl + Shift + F5: 重新執行

調試控制:
  F8: 設置/移除斷點
  F9: 下一步 (Step Over)
  F10: 步入 (Step Into)
  Shift + F10: 步出 (Step Out)
  Ctrl + F8: 條件斷點

面板切換:
  Ctrl + 1: 屬性面板
  Ctrl + 2: 執行狀態面板
  Ctrl + 3: 變量檢查器
  Ctrl + 4: 執行日誌
  Ctrl + 5: 性能分析

其他:
  Ctrl + F: 搜尋日誌
  Ctrl + Shift + C: 清除所有日誌
  Ctrl + Shift + E: 導出執行報告
```

---

## 📱 執行通知系統

### 執行完成通知

```
瀏覽器通知 (如果允許):
┌─────────────────────────────────┐
│ ✅ 工作流程執行完成              │
│ 客戶服務流程 v2.3                │
│ 耗時: 5 分 32 秒                 │
│ 狀態: 成功                       │
│ [查看結果]                       │
└─────────────────────────────────┘

執行失敗通知:
┌─────────────────────────────────┐
│ ❌ 工作流程執行失敗              │
│ 客戶服務流程 v2.3                │
│ 錯誤: Agent_2 連接超時           │
│ 節點: node_005                   │
│ [查看錯誤]                       │
└─────────────────────────────────┘

長時間執行提醒:
┌─────────────────────────────────┐
│ ⏱️ 工作流程執行中                │
│ 客戶服務流程 v2.3                │
│ 已執行: 10 分鐘                  │
│ 預計剩餘: 5 分鐘                 │
│ [查看進度]                       │
└─────────────────────────────────┘
```

---

## ✅ Part 3 檢查清單

### 完成項目
- [✅] 執行引擎設計（4 種執行模式）
- [✅] 實時執行追蹤 UI
  - [✅] 執行狀態面板
  - [✅] 畫布視覺反饋（5 種狀態）
  - [✅] 數據流動動畫
- [✅] 變量檢查器
  - [✅] 多範圍變量查看
  - [✅] 變量監控（Watch）功能
- [✅] 斷點調試功能
  - [✅] 3 種斷點類型
  - [✅] 斷點管理面板
  - [✅] 單步執行控制
- [✅] 執行日誌面板
  - [✅] 5 種日誌等級
  - [✅] 日誌搜尋和過濾
  - [✅] 日誌導出
- [✅] 錯誤堆疊追蹤
  - [✅] 詳細錯誤信息
  - [✅] 錯誤統計分析
  - [✅] 解決方案建議
- [✅] 性能分析工具
  - [✅] 節點執行時間分佈
  - [✅] 性能瓶頸識別
  - [✅] 成本分析
  - [✅] 時間軸視圖
- [✅] 快捷鍵系統
- [✅] 執行通知系統

### 下一步（Part 4）
- [ ] 版本控制系統設計
- [ ] 版本歷史管理
- [ ] 版本對比功能
- [ ] 多人協作功能
- [ ] 實時協作編輯
- [ ] 協作衝突解決
- [ ] 完整技術實現代碼
- [ ] 狀態管理架構

---

**文檔狀態**: Part 3/5 完成 ✅
**下一階段**: Part 4 - 版本控制與協作
**預計完成**: 2025-10-29
