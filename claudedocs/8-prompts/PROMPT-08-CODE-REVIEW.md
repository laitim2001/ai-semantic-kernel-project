# PROMPT-08: 代碼審查

**場景**: 代碼質量檢查、PR 創建前審查、最佳實踐驗證
**目標**: 代碼質量、安全檢查、最佳實踐驗證
**預估時間**: 5-10 分鐘
**適用對象**: PR 創建前、Feature 完成後、代碼重構後

---

## 🎯 使用方式

```
開發者: @PROMPT-08-CODE-REVIEW.md src/AIAgentPlatform.Application/Features/Agents
AI: [審查指定模組的代碼]
```

**變數說明**:
- `[路徑]`: 要審查的文件或目錄路徑 (可選)
- 如果未提供路徑,審查最近變更的文件

---

## 🤖 AI 執行指令

當開發者引用此 Prompt 時,請按以下順序執行:

### 步驟 1: 識別審查範圍
**如果提供了路徑**:
- 使用提供的路徑

**如果未提供路徑,識別最近變更**:
```bash
# 獲取最近變更的文件
git diff --name-only HEAD~1 HEAD

# 或獲取未提交的變更
git status --short
```

**輸出**:
```markdown
## 📋 審查範圍

### 目標文件/目錄
- **路徑**: [路徑]
- **文件數量**: [X 個]
- **代碼行數**: [約 X 行]

### 變更類型
- **新增文件**: [X 個]
- **修改文件**: [X 個]
- **刪除文件**: [X 個]
```

---

### 步驟 2: 代碼質量檢查
**讀取並分析目標代碼文件**

**檢查項目**:
1. **命名規範**:
   - 類名、方法名、變數名是否清晰
   - 是否遵循 C# 命名慣例

2. **方法長度**:
   - 方法是否過長 (>50 行)
   - 是否需要拆分

3. **複雜度**:
   - 嵌套層級是否過深 (>3 層)
   - 循環複雜度是否過高

4. **註釋**:
   - 是否有必要的註釋
   - 是否有過時的註釋

**輸出**:
```markdown
## ✅ 代碼質量檢查

### 命名規範
- ✅ **符合規範**: [X 個類/方法]
- ⚠️ **需要改進**: [列出不清晰的命名]

### 方法長度
- ✅ **合理長度 (<50 行)**: [X 個方法]
- ⚠️ **過長方法**: [列出,建議拆分]

### 代碼複雜度
- ✅ **複雜度合理**: [X 個方法]
- ⚠️ **複雜度過高**: [列出,建議簡化]

### 註釋質量
- ✅ **註釋充足**: [是/否]
- ⚠️ **需要補充註釋**: [列出位置]
```

---

### 步驟 3: 架構一致性檢查
**檢查是否符合項目架構原則**:

**檢查項目**:
1. **層級依賴**: 是否有反向依賴
2. **CQRS 分離**: Command/Query 是否正確分離
3. **DDD 原則**: Entity/ValueObject 是否正確使用
4. **Repository 模式**: 是否通過 Interface 訪問數據

**輸出**:
```markdown
## 🏗️ 架構一致性

### Domain Layer (如適用)
- ✅ **Entity 設計**: [是否符合 DDD]
- ✅ **ValueObject 使用**: [是否正確]
- ✅ **Domain Event**: [是否適當]

### Application Layer (如適用)
- ✅ **CQRS 分離**: [是否正確]
- ✅ **Handler 職責**: [是否單一]
- ✅ **Validation**: [是否完整]

### Infrastructure Layer (如適用)
- ✅ **Repository 實作**: [是否符合 Interface]
- ✅ **EF Configuration**: [是否使用 Fluent API]

### API Layer (如適用)
- ✅ **RESTful 設計**: [是否符合]
- ✅ **HTTP 狀態碼**: [是否正確]
- ✅ **錯誤處理**: [是否完整]

### 一致性評分
- **總體評分**: [X/10]
- **違反項目**: [列出]
```

---

### 步驟 4: 安全性審查
**檢查常見安全問題**:

**檢查項目**:
1. **輸入驗證**: 是否驗證所有用戶輸入
2. **SQL 注入**: 是否使用參數化查詢
3. **XSS 防護**: 是否有輸出編碼
4. **敏感數據**: 是否有硬編碼密碼或 API Key
5. **權限檢查**: API 端點是否有適當的授權檢查

**輸出**:
```markdown
## 🔒 安全性審查

### 輸入驗證
- ✅ **驗證完整**: [檢查結果]
- ⚠️ **缺少驗證**: [列出位置]

### SQL 注入防護
- ✅ **使用參數化查詢**: [是/否]
- ⚠️ **潛在風險**: [列出可疑代碼]

### 敏感數據處理
- ✅ **無硬編碼密碼**: [是/否]
- ⚠️ **敏感數據暴露**: [列出問題]

### API 安全
- ✅ **授權檢查**: [是否完整]
- ⚠️ **缺少保護**: [列出端點]

### 安全性評分
- **總體評分**: [X/10]
- **Critical 風險**: [X 個]
- **必須修復**: [列出]
```

---

### 步驟 5: 性能檢查
**檢查性能相關問題**:

**檢查項目**:
1. **N+1 查詢**: 是否有循環內查詢數據庫
2. **異步操作**: I/O 操作是否使用 async/await
3. **資源釋放**: IDisposable 是否正確釋放
4. **緩存使用**: 是否適當使用緩存

**輸出**:
```markdown
## ⚡ 性能檢查

### 數據庫操作
- ✅ **查詢優化**: [是否使用 Include/Projection]
- ⚠️ **N+1 問題**: [列出可疑位置]

### 異步編程
- ✅ **async/await 使用**: [覆蓋率]
- ⚠️ **同步阻塞**: [列出位置]

### 資源管理
- ✅ **資源釋放**: [是否正確]
- ⚠️ **潛在洩漏**: [列出風險]

### 性能評分
- **總體評分**: [X/10]
- **優化建議**: [列出優先級]
```

---

### 步驟 6: 測試覆蓋檢查
**檢查是否有對應的測試**:
```bash
# 查找對應的測試文件
# 例如: AgentService.cs 對應 AgentServiceTests.cs
find "C:\ai-semantic-kernel-project\tests" -name "*Tests.cs" | grep [相關名稱]
```

**輸出**:
```markdown
## 🧪 測試覆蓋檢查

### 單元測試
- ✅ **已有測試**: [列出]
- ⚠️ **缺少測試**: [列出需要測試的類/方法]

### 集成測試
- ✅ **已有測試**: [列出]
- ⚠️ **缺少測試**: [列出需要測試的功能]

### 測試覆蓋率估算
- **估計覆蓋率**: [X%]
- **目標覆蓋率**: 80%
- **差距**: [X%]

### 測試建議
- [列出需要補充的測試]
```

---

### 步驟 7: 最佳實踐檢查
**檢查是否遵循 C# 和 .NET 最佳實踐**:

**檢查項目**:
1. **SOLID 原則**: 是否遵循
2. **DRY 原則**: 是否有重複代碼
3. **錯誤處理**: 是否適當處理異常
4. **日誌記錄**: 是否有適當的日誌
5. **配置管理**: 是否使用配置文件而非硬編碼

**輸出**:
```markdown
## 📐 最佳實踐檢查

### SOLID 原則
- ✅ **單一職責**: [檢查結果]
- ✅ **開閉原則**: [檢查結果]
- ✅ **依賴倒置**: [檢查結果]

### 代碼重複
- ✅ **DRY 原則**: [是否有重複代碼]
- ⚠️ **重複片段**: [列出]

### 錯誤處理
- ✅ **異常處理**: [是否完整]
- ⚠️ **空異常捕獲**: [列出]

### 日誌記錄
- ✅ **日誌充足**: [是/否]
- ⚠️ **缺少日誌**: [列出關鍵位置]

### 最佳實踐評分
- **總體評分**: [X/10]
- **改進建議**: [列出]
```

---

### 步驟 8: 審查總結和建議
**綜合所有檢查,提供改進建議**:

**輸出**:
```markdown
## 🎯 代碼審查總結

### 總體評分
- **代碼質量**: [X/10]
- **架構一致性**: [X/10]
- **安全性**: [X/10]
- **性能**: [X/10]
- **測試覆蓋**: [X/10]
- **最佳實踐**: [X/10]
- **整體得分**: [X/10]

### ✅ 優點
1. [列出代碼良好的方面]
2. [...]

### ⚠️ 必須修復 (Blocking Issues)
1. [Critical 問題] - [修復建議]
2. [...]

### 💡 建議改進 (Non-Blocking)
1. [改進建議] - [預估時間]
2. [...]

### 下一步行動
- [ ] 修復 Blocking Issues
- [ ] 補充缺少的測試
- [ ] 應用建議改進 (可選)
- [ ] 重新執行代碼審查

### PR 狀態建議
- ✅ **可以創建 PR**: [如果無 Blocking Issues]
- ⚠️ **需要修復後再創建**: [如果有 Blocking Issues]
```

---

## 🎯 最終輸出摘要

**代碼審查完成**:
- 審查文件: [X 個]
- 發現問題: [X 個]
- Blocking Issues: [X 個]
- 建議改進: [X 個]

**下一步**:
- 如果無 Blocking Issues: 使用 `@PROMPT-06-PROGRESS-SAVE.md` 提交代碼
- 如果有 Blocking Issues: 修復問題後重新審查

---

## 📊 預期輸出

- **輸出長度**: ~2000-3000 字 (依審查範圍)
- **文件讀取數量**: 依審查範圍
- **檢查項目**: 7 大類
- **執行時間**: 5-10 分鐘

---

**版本**: 2.0.0
**最後更新**: 2025-12-08
**維護者**: Development Team
