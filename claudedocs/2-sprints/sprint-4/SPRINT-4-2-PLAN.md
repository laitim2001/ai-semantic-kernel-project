# SPRINT-4-2-PLAN.md - Sprint 4 è¨ˆåŠƒæ›¸ï¼šPersona Framework èˆ‡ Plugin ç†±é‡è¼‰å¯¦æ–½è¨ˆåŠƒ

**ç‰ˆæœ¬**: v2.1
**Sprint ç·¨è™Ÿ**: Sprint 4
**Sprint é€±æœŸ**: Week 10-12 (3 é€±)
**Phase**: Phase 1A - åŸºç¤å¹³å° (Foundation Platform)
**è¨ˆåŠƒæ—¥æœŸ**: 2025-12-16 ~ 2026-01-05
**ç‹€æ…‹**: ğŸ“‹ è¨ˆåŠƒéšæ®µ (Planned)
**å‰µå»ºæ—¥æœŸ**: 2025-11-13
**æœ€å¾Œæ›´æ–°**: 2025-11-13

---

## ğŸ“‘ ç›®éŒ„ (Table of Contents)

1. [è¦åŠƒæ–‡æª”åƒè€ƒ](#è¦åŠƒæ–‡æª”åƒè€ƒ)
2. [ç¬¬ä¸€éƒ¨åˆ†ï¼šæœ¬ Sprint è¦å»ºç«‹ä»€éº¼](#ç¬¬ä¸€éƒ¨åˆ†æœ¬-sprint-è¦å»ºç«‹ä»€éº¼-what-to-build)
3. [ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ€è¡“å¯¦æ–½æ–¹æ¡ˆ](#ç¬¬äºŒéƒ¨åˆ†æŠ€è¡“å¯¦æ–½æ–¹æ¡ˆ-how-to-build)
4. [ç¬¬ä¸‰éƒ¨åˆ†ï¼šç·¨ç¢¼è¦ç¯„](#ç¬¬ä¸‰éƒ¨åˆ†ç·¨ç¢¼è¦ç¯„)
5. [ç¬¬å››éƒ¨åˆ†ï¼šè³ªé‡ä¿è­‰](#ç¬¬å››éƒ¨åˆ†è³ªé‡ä¿è­‰)
6. [ç¬¬äº”éƒ¨åˆ†ï¼šåƒè€ƒæ–‡æª”](#ç¬¬äº”éƒ¨åˆ†åƒè€ƒæ–‡æª”)
7. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
8. [ç‰ˆæœ¬æ­·å²](#ç‰ˆæœ¬æ­·å²)

---

## è¦åŠƒæ–‡æª”åƒè€ƒ

**è¦åŠƒæ–‡æª”åƒè€ƒ**:
- ğŸ“‹ [MVP Scope Definition](../../1-planning/MVP-SCOPE-DEFINITION.md) - Phase 1A ç¯„åœ
- ğŸ“Š [Sprint Allocation Analysis](../../1-planning/SPRINT-ALLOCATION-ANALYSIS.md#sprint-4) - Sprint 4 åˆ†æ
- ğŸ¯ [Development Strategy](../../1-planning/DEVELOPMENT-STRATEGY.md) - Persona ç³»çµ±ç­–ç•¥
- ğŸ“ [Architecture Design Document](../../docs/architecture/Architecture-Design-Document.md) - ç³»çµ±æ¶æ§‹

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæœ¬ Sprint è¦å»ºç«‹ä»€éº¼ (What to Build)

### US 7.1: Persona æ¨¡æ¿é…ç½® (5 SP)

**User Story å®Œæ•´è¦æ ¼**: [US 7.1 - Persona æ¨¡æ¿é…ç½®](../../docs/user-stories/modules/module-07-persona-framework.md#us-71)

#### ä¸€ã€MVP ç¯„åœå®šç¾©

**å¿…é ˆå¯¦ç¾åŠŸèƒ½ (P0 - æœ¬ Sprint)**:
- [x] **Persona é…ç½®è¼‰å…¥å™¨**: æ”¯æ´ JSON/YAML æ ¼å¼
  - è¼‰å…¥ Persona é…ç½®æª”
  - è§£æé…ç½®çµæ§‹
  - é©—è­‰é…ç½®æ­£ç¢ºæ€§
  - é…ç½®ç†±é‡è¼‰ï¼ˆé–‹ç™¼æ¨¡å¼ï¼‰
  - **åƒè€ƒ**: [Persona Framework](../../docs/technical-implementation/01-backend-net9/03-persona-framework.md)

- [x] **10 ç¨®é è¨­ Persona æ¨¡æ¿**: é–‹ç®±å³ç”¨çš„æ¨¡æ¿
  - å°ˆæ¥­é¡§å• (Professional Consultant)
  - æŠ€è¡“å°ˆå®¶ (Technical Expert)
  - å®¢æœåŠ©ç† (Customer Support)
  - å‰µæ„å¤¥ä¼´ (Creative Partner)
  - æ•¸æ“šåˆ†æå¸« (Data Analyst)
  - æ•™è‚²å°å¸« (Educational Mentor)
  - ç ”ç©¶åŠ©ç† (Research Assistant)
  - ç”¢å“ç¶“ç† (Product Manager)
  - éŠ·å”®é¡§å• (Sales Consultant)
  - æ³•å¾‹é¡§å• (Legal Advisor)
  - **åƒè€ƒ**: [Persona Templates](../../docs/persona-templates/)

- [x] **Schema é©—è­‰æ©Ÿåˆ¶**: JSON Schema / YAML Schema
  - é…ç½®æ ¼å¼é©—è­‰
  - å¿…å¡«æ¬„ä½æª¢æŸ¥
  - æ•¸å€¼ç¯„åœé©—è­‰
  - æšèˆ‰å€¼é©—è­‰
  - **åƒè€ƒ**: [Validation Strategy](../../docs/technical-implementation/01-backend-net9/06-validation-strategy.md)

- [x] **é…ç½®ä¸€è‡´æ€§æª¢æ¸¬**: é˜²æ­¢è¡çªé…ç½®
  - é¢¨æ ¼ä¸€è‡´æ€§æª¢æŸ¥ï¼ˆä¾‹å¦‚ï¼šprofessional + casual è¡çªï¼‰
  - ç¦æ­¢è©å½™æ¸…å–®é©—è­‰
  - å®‰å…¨å®ˆå‰‡æª¢æŸ¥
  - **åƒè€ƒ**: [Persona Configuration Validation](../../docs/technical-implementation/01-backend-net9/03-persona-framework.md#validation)

**æ˜ç¢ºæ’é™¤ Phase 2 åŠŸèƒ½ (å»¶å¾Œ)**:
- âŒ **Persona A/B æ¸¬è©¦**: å»¶å¾Œåˆ° Sprint 5
- âŒ **Persona å‹•æ…‹èª¿æ•´**: å»¶å¾Œåˆ° Sprint 5
- âŒ **Persona ä¸€è‡´æ€§è©•åˆ†**: å»¶å¾Œåˆ° Sprint 6
- âŒ **å¤šèªè¨€ Persona æ”¯æ´**: å»¶å¾Œåˆ° Phase 2

**MVP ç¯„åœåƒè€ƒ**:
- ğŸ“– [MVP Scope Definition](../../1-planning/MVP-SCOPE-DEFINITION.md#persona-framework) - Persona ç³»çµ±åœ¨ Phase 1A çš„ç¯„åœ
- ğŸ“– [Sprint Allocation Analysis](../../1-planning/SPRINT-ALLOCATION-ANALYSIS.md#sprint-4) - Sprint 4 ä»»å‹™åˆ†é…

#### äºŒã€è©³ç´°æŠ€è¡“è¦æ ¼

##### Persona é…ç½®æ ¼å¼è¦ç¯„

**YAML é…ç½®ç¯„ä¾‹**:
```yaml
# persona-config.yaml
persona:
  name: "Alice"
  role: "æŠ€è¡“é¡§å•"
  expertise:
    - "é›²ç«¯æ¶æ§‹"
    - "DevOps"
    - "å®‰å…¨æ€§"

  communication_style:
    formality: "professional"      # professional, casual, friendly
    verbosity: "balanced"           # concise, balanced, detailed
    tone: "encouraging"             # neutral, encouraging, assertive

  response_pattern:
    proactivity: "moderate"         # passive, moderate, proactive
    style: "exploratory"            # directive, exploratory, collaborative

  language_preferences:
    technical_terms: "always_explain"  # use_freely, explain_when_complex, always_explain
    examples: "provide_when_helpful"   # minimal, provide_when_helpful, abundant

  safety_guardrails:
    forbidden_topics:
      - "æ”¿æ²»"
      - "å®—æ•™"
    forbidden_words:
      - "çµ•å°"
      - "ä¿è­‰"
      - "ä¸€å®š"
    max_speculation: "low"          # none, low, moderate

  personality_traits:
    - "è€å¿ƒè§£é‡‹è¤‡é›œæ¦‚å¿µ"
    - "ä½¿ç”¨é¡æ¯”å’Œå¯¦ä¾‹"
    - "é¼“å‹µæœ€ä½³å¯¦è¸"
    - "é¿å…éåº¦æŠ€è¡“è¡“èª"
```

**JSON é…ç½®ç¯„ä¾‹**:
```json
{
  "persona": {
    "name": "Alice",
    "role": "æŠ€è¡“é¡§å•",
    "expertise": ["é›²ç«¯æ¶æ§‹", "DevOps", "å®‰å…¨æ€§"],
    "communication_style": {
      "formality": "professional",
      "verbosity": "balanced",
      "tone": "encouraging"
    },
    "response_pattern": {
      "proactivity": "moderate",
      "style": "exploratory"
    },
    "language_preferences": {
      "technical_terms": "always_explain",
      "examples": "provide_when_helpful"
    },
    "safety_guardrails": {
      "forbidden_topics": ["æ”¿æ²»", "å®—æ•™"],
      "forbidden_words": ["çµ•å°", "ä¿è­‰", "ä¸€å®š"],
      "max_speculation": "low"
    },
    "personality_traits": [
      "è€å¿ƒè§£é‡‹è¤‡é›œæ¦‚å¿µ",
      "ä½¿ç”¨é¡æ¯”å’Œå¯¦ä¾‹",
      "é¼“å‹µæœ€ä½³å¯¦è¸",
      "é¿å…éåº¦æŠ€è¡“è¡“èª"
    ]
  }
}
```

**JSON Schema é©—è­‰è¦ç¯„**:
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["persona"],
  "properties": {
    "persona": {
      "type": "object",
      "required": ["name", "role", "communication_style"],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 2,
          "maxLength": 50,
          "description": "Persona åç¨±"
        },
        "role": {
          "type": "string",
          "minLength": 2,
          "maxLength": 100,
          "description": "Persona è§’è‰²"
        },
        "expertise": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "maxItems": 10,
          "description": "å°ˆæ¥­é ˜åŸŸæ¸…å–®"
        },
        "communication_style": {
          "type": "object",
          "required": ["formality", "verbosity", "tone"],
          "properties": {
            "formality": {
              "type": "string",
              "enum": ["professional", "casual", "friendly"]
            },
            "verbosity": {
              "type": "string",
              "enum": ["concise", "balanced", "detailed"]
            },
            "tone": {
              "type": "string",
              "enum": ["neutral", "encouraging", "assertive"]
            }
          }
        },
        "response_pattern": {
          "type": "object",
          "properties": {
            "proactivity": {
              "type": "string",
              "enum": ["passive", "moderate", "proactive"]
            },
            "style": {
              "type": "string",
              "enum": ["directive", "exploratory", "collaborative"]
            }
          }
        },
        "safety_guardrails": {
          "type": "object",
          "properties": {
            "forbidden_topics": {
              "type": "array",
              "items": { "type": "string" }
            },
            "forbidden_words": {
              "type": "array",
              "items": { "type": "string" }
            },
            "max_speculation": {
              "type": "string",
              "enum": ["none", "low", "moderate"]
            }
          }
        }
      }
    }
  }
}
```

**Schema é©—è­‰åƒè€ƒ**:
- ğŸ“„ [JSON Schema Specification](https://json-schema.org/) - JSON Schema å®˜æ–¹è¦ç¯„
- ğŸ“„ [Validation Strategy](../../docs/technical-implementation/01-backend-net9/06-validation-strategy.md) - FluentValidation å¯¦ä½œ

##### Backend API è¦æ ¼

**API ç«¯é»**: `POST /api/v1/personas`

**Request**:
```json
{
  "name": "Alice",
  "role": "æŠ€è¡“é¡§å•",
  "description": "å°ˆç²¾æ–¼é›²ç«¯æ¶æ§‹èˆ‡ DevOps çš„æŠ€è¡“é¡§å•",
  "configJson": "{\"persona\": {...}}",  // å®Œæ•´ Persona é…ç½® JSON
  "isTemplate": false,
  "templateId": null
}
```

**Response** (201 Created):
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "Alice",
  "role": "æŠ€è¡“é¡§å•",
  "description": "å°ˆç²¾æ–¼é›²ç«¯æ¶æ§‹èˆ‡ DevOps çš„æŠ€è¡“é¡§å•",
  "configJson": "{\"persona\": {...}}",
  "isTemplate": false,
  "templateId": null,
  "validationStatus": "Valid",
  "validationErrors": [],
  "createdAt": "2025-12-16T10:00:00Z",
  "updatedAt": "2025-12-16T10:00:00Z"
}
```

**é©—è­‰è¦å‰‡**:
- `name`: å¿…å¡«, é•·åº¦ 2-50 å­—ç¬¦, ä¸å¯é‡è¤‡
- `role`: å¿…å¡«, é•·åº¦ 2-100 å­—ç¬¦
- `configJson`: å¿…å¡«, å¿…é ˆæ˜¯æœ‰æ•ˆçš„ JSON, ç¬¦åˆ Persona Schema
- `communication_style.formality`: å¿…å¡«, æšèˆ‰å€¼ ["professional", "casual", "friendly"]
- `communication_style.verbosity`: å¿…å¡«, æšèˆ‰å€¼ ["concise", "balanced", "detailed"]

**éŒ¯èª¤è™•ç†**:
- `400 Bad Request`: é©—è­‰å¤±æ•— (JSON æ ¼å¼éŒ¯èª¤ã€Schema ä¸ç¬¦)
- `409 Conflict`: Persona åç¨±å·²å­˜åœ¨
- `422 Unprocessable Entity`: é…ç½®è¡çªï¼ˆä¾‹å¦‚ï¼šprofessional + casualï¼‰
- `500 Internal Server Error`: æœå‹™å™¨éŒ¯èª¤

**éŒ¯èª¤è™•ç†åƒè€ƒ**:
- ğŸ“„ [Error Handling Strategy](../../docs/api/api-design.md#error-handling) - çµ±ä¸€éŒ¯èª¤è™•ç†
- ğŸ“„ [HTTP Status Codes](../../docs/api/api-design.md#http-status-codes) - ç‹€æ…‹ç¢¼è¦ç¯„

##### Database Schema

**Table**: `personas`

```sql
CREATE TABLE personas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL,
    role VARCHAR(100) NOT NULL,
    description TEXT,
    config_json JSONB NOT NULL,
    is_template BOOLEAN DEFAULT false,
    template_id UUID REFERENCES persona_templates(id),
    validation_status VARCHAR(20) NOT NULL DEFAULT 'Valid', -- Valid, Invalid, Warning
    validation_errors JSONB,
    is_active BOOLEAN DEFAULT true,
    is_deleted BOOLEAN DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100),
    updated_by VARCHAR(100),

    CONSTRAINT uk_personas_name UNIQUE(name),
    CONSTRAINT ck_validation_status CHECK (validation_status IN ('Valid', 'Invalid', 'Warning'))
);

-- Indexes
CREATE INDEX idx_personas_name ON personas(name);
CREATE INDEX idx_personas_role ON personas(role);
CREATE INDEX idx_personas_is_template ON personas(is_template);
CREATE INDEX idx_personas_is_active ON personas(is_active);
CREATE INDEX idx_personas_is_deleted ON personas(is_deleted);
CREATE INDEX idx_personas_created_at ON personas(created_at DESC);

-- JSONB Index for fast queries on config
CREATE INDEX idx_personas_config_json ON personas USING GIN (config_json);
```

**Table**: `persona_templates`

```sql
CREATE TABLE persona_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(50) NOT NULL UNIQUE,
    category VARCHAR(50) NOT NULL, -- Professional, Technical, Support, Creative, etc.
    description TEXT,
    config_json JSONB NOT NULL,
    preview_prompt TEXT,
    usage_count INT DEFAULT 0,
    is_builtin BOOLEAN DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_persona_templates_category ON persona_templates(category);
CREATE INDEX idx_persona_templates_is_builtin ON persona_templates(is_builtin);
```

**Database è¨­è¨ˆåƒè€ƒ**:
- ğŸ—„ï¸ [Database Schema Design](../../docs/api/database-schema.md) - å®Œæ•´ Schema è¨­è¨ˆ
- ğŸ—„ï¸ [JSONB in PostgreSQL](https://www.postgresql.org/docs/current/datatype-json.html) - JSONB ä½¿ç”¨æŒ‡å—
- ğŸ—„ï¸ [ADR-004: PostgreSQL Selection](../../docs/architecture/adr/ADR-004-database-selection.md) - è³‡æ–™åº«é¸å‹

##### C# Domain Entity è¨­è¨ˆ

```csharp
// Domain/Entities/Persona.cs
public sealed class Persona : BaseEntity
{
    // Properties
    public Guid Id { get; private set; }
    public string Name { get; private set; }
    public string Role { get; private set; }
    public string? Description { get; private set; }
    public PersonaConfig Config { get; private set; }
    public bool IsTemplate { get; private set; }
    public Guid? TemplateId { get; private set; }
    public ValidationStatus ValidationStatus { get; private set; }
    public List<string> ValidationErrors { get; private set; }
    public bool IsActive { get; private set; }

    // Factory Method
    public static Persona Create(
        Guid userId,
        string name,
        string role,
        PersonaConfig config,
        string? description = null,
        bool isTemplate = false,
        Guid? templateId = null)
    {
        // Validation
        if (string.IsNullOrWhiteSpace(name))
            throw new ArgumentException("Persona name is required", nameof(name));

        if (string.IsNullOrWhiteSpace(role))
            throw new ArgumentException("Persona role is required", nameof(role));

        var persona = new Persona
        {
            Id = Guid.NewGuid(),
            Name = name,
            Role = role,
            Description = description,
            Config = config ?? throw new ArgumentNullException(nameof(config)),
            IsTemplate = isTemplate,
            TemplateId = templateId,
            ValidationStatus = ValidationStatus.Valid,
            ValidationErrors = new List<string>(),
            IsActive = true,
            CreatedBy = userId.ToString(),
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

        // Validate configuration
        var validationResult = persona.ValidateConfig();
        persona.ValidationStatus = validationResult.IsValid ? ValidationStatus.Valid : ValidationStatus.Invalid;
        persona.ValidationErrors = validationResult.Errors;

        // Domain Event
        persona.RaiseDomainEvent(new PersonaCreatedDomainEvent(persona.Id, persona.Name));

        return persona;
    }

    // Domain Methods
    public void UpdateConfig(PersonaConfig newConfig)
    {
        Config = newConfig ?? throw new ArgumentNullException(nameof(newConfig));

        // Re-validate
        var validationResult = ValidateConfig();
        ValidationStatus = validationResult.IsValid ? ValidationStatus.Valid : ValidationStatus.Invalid;
        ValidationErrors = validationResult.Errors;

        UpdatedAt = DateTime.UtcNow;
        RaiseDomainEvent(new PersonaConfigUpdatedDomainEvent(Id, Name));
    }

    public void Activate()
    {
        if (ValidationStatus == ValidationStatus.Invalid)
            throw new InvalidOperationException("Cannot activate a Persona with invalid configuration");

        IsActive = true;
        UpdatedAt = DateTime.UtcNow;
    }

    public void Deactivate()
    {
        IsActive = false;
        UpdatedAt = DateTime.UtcNow;
    }

    private ValidationResult ValidateConfig()
    {
        var errors = new List<string>();

        // Check communication style consistency
        if (Config.CommunicationStyle.Formality == Formality.Professional &&
            Config.CommunicationStyle.Tone == Tone.Casual)
        {
            errors.Add("Professional formality conflicts with casual tone");
        }

        // Check forbidden words in personality traits
        foreach (var trait in Config.PersonalityTraits)
        {
            foreach (var forbiddenWord in Config.SafetyGuardrails.ForbiddenWords)
            {
                if (trait.Contains(forbiddenWord, StringComparison.OrdinalIgnoreCase))
                {
                    errors.Add($"Personality trait contains forbidden word: '{forbiddenWord}'");
                }
            }
        }

        return new ValidationResult(errors.Count == 0, errors);
    }
}

// Domain/ValueObjects/PersonaConfig.cs
public sealed class PersonaConfig : ValueObject
{
    public string Name { get; private set; }
    public string Role { get; private set; }
    public List<string> Expertise { get; private set; }
    public CommunicationStyle CommunicationStyle { get; private set; }
    public ResponsePattern ResponsePattern { get; private set; }
    public LanguagePreferences LanguagePreferences { get; private set; }
    public SafetyGuardrails SafetyGuardrails { get; private set; }
    public List<string> PersonalityTraits { get; private set; }

    public static PersonaConfig FromJson(string json)
    {
        // Parse JSON and create PersonaConfig
        var jsonDoc = JsonDocument.Parse(json);
        var personaElement = jsonDoc.RootElement.GetProperty("persona");

        return new PersonaConfig
        {
            Name = personaElement.GetProperty("name").GetString()!,
            Role = personaElement.GetProperty("role").GetString()!,
            Expertise = personaElement.GetProperty("expertise")
                .EnumerateArray()
                .Select(e => e.GetString()!)
                .ToList(),
            CommunicationStyle = CommunicationStyle.FromJson(personaElement.GetProperty("communication_style")),
            ResponsePattern = ResponsePattern.FromJson(personaElement.GetProperty("response_pattern")),
            LanguagePreferences = LanguagePreferences.FromJson(personaElement.GetProperty("language_preferences")),
            SafetyGuardrails = SafetyGuardrails.FromJson(personaElement.GetProperty("safety_guardrails")),
            PersonalityTraits = personaElement.GetProperty("personality_traits")
                .EnumerateArray()
                .Select(t => t.GetString()!)
                .ToList()
        };
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return Name;
        yield return Role;
        yield return string.Join(",", Expertise);
    }
}

// Domain/ValueObjects/CommunicationStyle.cs
public sealed class CommunicationStyle : ValueObject
{
    public Formality Formality { get; private set; }
    public Verbosity Verbosity { get; private set; }
    public Tone Tone { get; private set; }

    public static CommunicationStyle FromJson(JsonElement json)
    {
        return new CommunicationStyle
        {
            Formality = Enum.Parse<Formality>(json.GetProperty("formality").GetString()!, ignoreCase: true),
            Verbosity = Enum.Parse<Verbosity>(json.GetProperty("verbosity").GetString()!, ignoreCase: true),
            Tone = Enum.Parse<Tone>(json.GetProperty("tone").GetString()!, ignoreCase: true)
        };
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return Formality;
        yield return Verbosity;
        yield return Tone;
    }
}

// Domain/Enums
public enum Formality { Professional, Casual, Friendly }
public enum Verbosity { Concise, Balanced, Detailed }
public enum Tone { Neutral, Encouraging, Assertive }
public enum Proactivity { Passive, Moderate, Proactive }
public enum ResponseStyle { Directive, Exploratory, Collaborative }
public enum TechnicalTermUsage { UseFreely, ExplainWhenComplex, AlwaysExplain }
public enum ExampleUsage { Minimal, ProvideWhenHelpful, Abundant }
public enum SpeculationLevel { None, Low, Moderate }
public enum ValidationStatus { Valid, Invalid, Warning }
```

**Domain Layer è¨­è¨ˆåƒè€ƒ**:
- ğŸ“ [Domain Layer Design](../../docs/technical-implementation/01-backend-net9/07-domain-layer.md)
- ğŸ“ [Value Objects Pattern](../../docs/architecture/adr/ADR-005-value-objects.md)
- ğŸ“ [Domain Events](../../docs/technical-implementation/01-backend-net9/07-domain-layer.md#domain-events)

### US 7.2: Persona-Driven Prompt Engineering (5 SP)

**ç›®æ¨™**: æ ¹æ“š Persona é…ç½®å‹•æ…‹ç”Ÿæˆ System Promptï¼Œå¯¦ç¾å€‹æ€§åŒ– AI è¡Œç‚º

#### US 7.2.1: MVP ç¯„åœå®šç¾©

**Must Have (Phase 1)**:
- âœ… **Prompt æ¨¡æ¿å¼•æ“**: Liquid/Handlebars æ¨¡æ¿èªæ³•æ”¯æ´ï¼Œè®Šæ•¸æ’å€¼èˆ‡æ¢ä»¶æ¸²æŸ“
- âœ… **Persona è¡Œç‚ºæ³¨å…¥**: æ ¹æ“š `CommunicationStyle`, `ResponsePattern`, `Expertise` å‹•æ…‹ç”ŸæˆæŒ‡ä»¤
- âœ… **å®‰å…¨å®ˆå‰‡æ³¨å…¥**: è‡ªå‹•æ³¨å…¥ `forbidden_topics`, `forbidden_words`, è¼¸å‡ºæ ¼å¼é™åˆ¶
- âœ… **åŸºç¤æ¨¡æ¿ç®¡ç†**: 10 å€‹å…§å»ºæ¨¡æ¿ (å°æ‡‰ 10 ç¨® Persona é¡å‹)
- âœ… **å‹•æ…‹ Prompt çµ„åˆ**: ç³»çµ±æŒ‡ä»¤ + Persona æŒ‡ä»¤ + å®‰å…¨è¦å‰‡ + ä½¿ç”¨è€…è¨Šæ¯
- âœ… **Token é™åˆ¶ç®¡ç†**: è‡ªå‹•æˆªæ–·éé•·çš„ Promptï¼Œä¿ç•™æ ¸å¿ƒæŒ‡ä»¤

**Excluded (Phase 2)**:
- âŒ ä½¿ç”¨è€…è‡ªå®šç¾©æ¨¡æ¿ (Phase 2: US 8.1)
- âŒ æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶èˆ‡å›æ»¾ (Phase 2)
- âŒ A/B Testing èˆ‡æ¨¡æ¿æ•ˆæœåˆ†æ (Phase 2)
- âŒ å¤šèªè¨€æ¨¡æ¿æ”¯æ´ (Phase 2)

#### US 7.2.2: Prompt æ¨¡æ¿æ ¼å¼

**Liquid æ¨¡æ¿ç¯„ä¾‹**:
```liquid
# System Role
You are {{ persona.name }}, a {{ persona.role }}.

# Expertise Areas
Your areas of expertise include:
{% for area in persona.expertise %}
- {{ area }}
{% endfor %}

# Communication Style
- Formality: {{ persona.communication_style.formality }}
- Verbosity: {{ persona.communication_style.verbosity }}
- Tone: {{ persona.communication_style.tone }}

# Response Patterns
{% if persona.response_pattern.use_examples %}
Always provide concrete examples to illustrate your points.
{% endif %}

{% if persona.response_pattern.step_by_step %}
Break down complex problems into step-by-step solutions.
{% endif %}

# Safety Guardrails
## Forbidden Topics
{% for topic in persona.safety_guardrails.forbidden_topics %}
- Do not discuss: {{ topic }}
{% endfor %}

## Output Restrictions
- Language: {{ persona.safety_guardrails.language_restriction }}
- Max response length: {{ persona.safety_guardrails.max_response_length }} tokens

# Your Task
{{ user_message }}
```

**ç”Ÿæˆçš„ System Prompt ç¯„ä¾‹**:
```
# System Role
You are Alice, a Cloud Architect.

# Expertise Areas
Your areas of expertise include:
- AWS Architecture
- Kubernetes
- DevOps Best Practices

# Communication Style
- Formality: professional
- Verbosity: concise
- Tone: encouraging

# Response Patterns
Always provide concrete examples to illustrate your points.
Break down complex problems into step-by-step solutions.

# Safety Guardrails
## Forbidden Topics
- Do not discuss: politics
- Do not discuss: religion

## Output Restrictions
- Language: zh-TW
- Max response length: 2000 tokens

# Your Task
How do I design a highly available Kubernetes cluster?
```

#### US 7.2.3: Prompt ç”Ÿæˆæ¼”ç®—æ³•

**ç”Ÿæˆæµç¨‹**:
```yaml
Step 1: è¼‰å…¥ Persona é…ç½®
  - å¾è³‡æ–™åº«è®€å– Persona Entity
  - ååºåˆ—åŒ– PersonaConfig Value Object

Step 2: é¸æ“‡æ¨¡æ¿
  - æ ¹æ“š Persona.Role é¸æ“‡å°æ‡‰æ¨¡æ¿
  - æ”¯æ´ Template Override (Persona å¯æŒ‡å®šè‡ªå®šç¾©æ¨¡æ¿)

Step 3: è®Šæ•¸æ³¨å…¥
  - å°‡ PersonaConfig æ‰€æœ‰å±¬æ€§æ˜ å°„ç‚ºæ¨¡æ¿è®Šæ•¸
  - é¡å¤–æ³¨å…¥ system_time, user_context ç­‰é‹è¡Œæ™‚è®Šæ•¸

Step 4: æ¨¡æ¿æ¸²æŸ“
  - ä½¿ç”¨ Liquid Template Engine æ¸²æŸ“
  - è™•ç†æ¢ä»¶é‚è¼¯ã€è¿´åœˆã€éæ¿¾å™¨

Step 5: å®‰å…¨æª¢æŸ¥èˆ‡æˆªæ–·
  - é©—è­‰ç”Ÿæˆçš„ Prompt ä¸å«æ•æ„Ÿè³‡è¨Š
  - Token Counting (ä½¿ç”¨ TikToken)
  - è¶…éé™åˆ¶æ™‚æ™ºèƒ½æˆªæ–· (ä¿ç•™æ ¸å¿ƒæŒ‡ä»¤ + éƒ¨åˆ† context)

Step 6: å¿«å–èˆ‡è¿”å›
  - å¿«å–ç”Ÿæˆçš„ Prompt (Redis, TTL 1 hour)
  - è¿”å›æœ€çµ‚ Prompt çµ¦ Agent Runtime
```

**C# æ¼”ç®—æ³•å¯¦ä½œ**:
```csharp
public sealed class PromptGenerationService : IPromptGenerationService
{
    private readonly IPromptTemplateRepository _templateRepo;
    private readonly IFluidTemplateEngine _liquidEngine;
    private readonly ITokenCounter _tokenCounter;
    private readonly IDistributedCache _cache;
    private readonly ILogger<PromptGenerationService> _logger;

    public async Task<Result<GeneratedPrompt>> GeneratePromptAsync(
        Guid personaId,
        string userMessage,
        CancellationToken cancellationToken = default)
    {
        try
        {
            // Step 1: è¼‰å…¥ Persona é…ç½®
            var persona = await _personaRepo.GetByIdAsync(personaId, cancellationToken);
            if (persona is null)
                return Result<GeneratedPrompt>.Failure("Persona not found");

            // Step 2: é¸æ“‡æ¨¡æ¿
            var templateKey = persona.Config.TemplateOverride
                ?? GetDefaultTemplateKey(persona.Role);
            var template = await _templateRepo.GetByKeyAsync(templateKey, cancellationToken);

            // Step 3: è®Šæ•¸æ³¨å…¥
            var variables = new Dictionary<string, object>
            {
                ["persona"] = new
                {
                    name = persona.Name,
                    role = persona.Role,
                    expertise = persona.Config.Expertise,
                    communication_style = persona.Config.CommunicationStyle,
                    response_pattern = persona.Config.ResponsePattern,
                    safety_guardrails = persona.Config.SafetyGuardrails
                },
                ["user_message"] = userMessage,
                ["system_time"] = DateTime.UtcNow.ToString("o")
            };

            // Step 4: æ¨¡æ¿æ¸²æŸ“
            var renderedPrompt = await _liquidEngine.RenderAsync(
                template.Content,
                variables,
                cancellationToken);

            // Step 5: å®‰å…¨æª¢æŸ¥èˆ‡æˆªæ–·
            var tokenCount = _tokenCounter.Count(renderedPrompt);
            var maxTokens = persona.Config.SafetyGuardrails.MaxPromptTokens ?? 4000;

            if (tokenCount > maxTokens)
            {
                renderedPrompt = TruncatePrompt(renderedPrompt, maxTokens);
                _logger.LogWarning(
                    "Prompt truncated for Persona {PersonaId}: {Original} -> {Truncated} tokens",
                    personaId, tokenCount, maxTokens);
            }

            var result = new GeneratedPrompt
            {
                Content = renderedPrompt,
                TokenCount = tokenCount,
                PersonaId = personaId,
                GeneratedAt = DateTime.UtcNow
            };

            // Step 6: å¿«å–
            await CachePromptAsync(personaId, userMessage, result, cancellationToken);

            return Result<GeneratedPrompt>.Success(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to generate prompt for Persona {PersonaId}", personaId);
            return Result<GeneratedPrompt>.Failure($"Prompt generation failed: {ex.Message}");
        }
    }

    private string TruncatePrompt(string prompt, int maxTokens)
    {
        // æ™ºèƒ½æˆªæ–·ï¼šä¿ç•™ System Role + Safety Guardrailsï¼Œç¸®æ¸› Examples/Context
        var sections = prompt.Split("# ", StringSplitOptions.RemoveEmptyEntries);
        var criticalSections = sections.Where(s =>
            s.StartsWith("System Role") ||
            s.StartsWith("Safety Guardrails")).ToList();

        var truncated = string.Join("# ", criticalSections);
        return truncated;
    }

    private string GetDefaultTemplateKey(string role)
    {
        return role switch
        {
            "Cloud Architect" => "template_cloud_architect",
            "Data Scientist" => "template_data_scientist",
            "Product Manager" => "template_product_manager",
            // ... å…¶ä»– 7 ç¨® Persona
            _ => "template_default"
        };
    }
}
```

#### US 7.2.4: Backend API è¦æ ¼

**API Endpoint**: `POST /api/v1/personas/{personaId}/prompts/generate`

**Request**:
```json
{
  "userMessage": "How do I design a highly available Kubernetes cluster?",
  "includeContext": true,
  "contextData": {
    "currentProject": "E-Commerce Platform",
    "userRole": "DevOps Engineer"
  }
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "data": {
    "promptId": "123e4567-e89b-12d3-a456-426614174000",
    "content": "# System Role\nYou are Alice, a Cloud Architect...",
    "tokenCount": 1250,
    "personaId": "123e4567-e89b-12d3-a456-426614174001",
    "generatedAt": "2024-01-15T10:30:00Z",
    "cacheHit": false
  }
}
```

**Error Response (400 Bad Request)**:
```json
{
  "success": false,
  "error": {
    "code": "PROMPT_GENERATION_FAILED",
    "message": "Template not found for role: Cloud Architect",
    "details": {
      "personaId": "123e4567-e89b-12d3-a456-426614174001",
      "templateKey": "template_cloud_architect"
    }
  }
}
```

#### US 7.2.5: Database Schema

**Prompt Templates Table**:
```sql
CREATE TABLE prompt_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_key VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    content TEXT NOT NULL, -- Liquid template å…§å®¹
    persona_role VARCHAR(100) NOT NULL, -- é—œè¯çš„ Persona è§’è‰²
    version INTEGER NOT NULL DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

    CONSTRAINT chk_template_key_format CHECK (template_key ~ '^template_[a-z_]+$')
);

CREATE INDEX idx_prompt_templates_role ON prompt_templates(persona_role);
CREATE INDEX idx_prompt_templates_active ON prompt_templates(is_active) WHERE is_active = true;
```

**Generated Prompts Cache Table** (å¯é¸ï¼Œè¼”åŠ©å¿«å–æŸ¥è©¢):
```sql
CREATE TABLE generated_prompts_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    persona_id UUID NOT NULL REFERENCES personas(id) ON DELETE CASCADE,
    user_message_hash VARCHAR(64) NOT NULL, -- SHA256(userMessage)
    content TEXT NOT NULL,
    token_count INTEGER NOT NULL,
    generated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMP NOT NULL, -- TTL 1 hour

    CONSTRAINT uq_persona_message UNIQUE (persona_id, user_message_hash)
);

CREATE INDEX idx_generated_prompts_expires ON generated_prompts_cache(expires_at);
```

#### US 7.2.6: Application Layer è¨­è¨ˆ

**CQRS Command**:
```csharp
public sealed record GeneratePromptCommand(
    Guid PersonaId,
    string UserMessage,
    bool IncludeContext,
    Dictionary<string, object>? ContextData) : IRequest<Result<GeneratedPromptDto>>;

public sealed class GeneratePromptCommandHandler
    : IRequestHandler<GeneratePromptCommand, Result<GeneratedPromptDto>>
{
    private readonly IPromptGenerationService _promptService;
    private readonly IMapper _mapper;

    public async Task<Result<GeneratedPromptDto>> Handle(
        GeneratePromptCommand request,
        CancellationToken cancellationToken)
    {
        var result = await _promptService.GeneratePromptAsync(
            request.PersonaId,
            request.UserMessage,
            cancellationToken);

        if (!result.IsSuccess)
            return Result<GeneratedPromptDto>.Failure(result.Error);

        var dto = _mapper.Map<GeneratedPromptDto>(result.Value);
        return Result<GeneratedPromptDto>.Success(dto);
    }
}
```

**CQRS Query**:
```csharp
public sealed record GetPromptTemplatesQuery(
    string? PersonaRole) : IRequest<Result<List<PromptTemplateDto>>>;

public sealed class GetPromptTemplatesQueryHandler
    : IRequestHandler<GetPromptTemplatesQuery, Result<List<PromptTemplateDto>>>
{
    private readonly IPromptTemplateRepository _repository;
    private readonly IMapper _mapper;

    public async Task<Result<List<PromptTemplateDto>>> Handle(
        GetPromptTemplatesQuery request,
        CancellationToken cancellationToken)
    {
        var templates = await _repository.GetByRoleAsync(
            request.PersonaRole,
            cancellationToken);

        var dtos = _mapper.Map<List<PromptTemplateDto>>(templates);
        return Result<List<PromptTemplateDto>>.Success(dtos);
    }
}
```

#### US 7.2.7: Token Counting èˆ‡é™åˆ¶ç®¡ç†

**ä½¿ç”¨ TikToken Library**:
```csharp
public sealed class TikTokenCounter : ITokenCounter
{
    private readonly Encoding _encoding;

    public TikTokenCounter()
    {
        // ä½¿ç”¨ GPT-4 çš„ cl100k_base encoding
        _encoding = Encoding.Get("cl100k_base");
    }

    public int Count(string text)
    {
        var tokens = _encoding.Encode(text);
        return tokens.Count;
    }

    public string Truncate(string text, int maxTokens)
    {
        var tokens = _encoding.Encode(text);
        if (tokens.Count <= maxTokens)
            return text;

        var truncatedTokens = tokens.Take(maxTokens).ToList();
        return _encoding.Decode(truncatedTokens);
    }
}
```

**ç›¸é—œåƒè€ƒæ–‡ä»¶**:
- ğŸ”§ [TikToken .NET Library](https://github.com/microsoft/Tokenizer)
- ğŸ“ [OpenAI Tokenizer Guide](https://platform.openai.com/tokenizer)

#### US 7.2.8: åƒè€ƒæ–‡ä»¶

**Domain è¨­è¨ˆåƒè€ƒ**:
- ğŸ“ [Prompt Engineering Best Practices](../../docs/technical-implementation/03-ai-integration/01-prompt-engineering.md)
- ğŸ“ [Liquid Template Syntax](https://shopify.github.io/liquid/)
- ğŸ“ [Token Counting Strategies](../../docs/technical-implementation/03-ai-integration/02-token-management.md)

**Implementation åƒè€ƒ**:
- ğŸ”¨ [IPromptGenerationService Interface](../../src/AIAgentPlatform.Application/Interfaces/IPromptGenerationService.cs)
- ğŸ”¨ [PromptTemplateRepository](../../src/AIAgentPlatform.Infrastructure/Repositories/PromptTemplateRepository.cs)
- ğŸ”¨ [Liquid Template Engine Integration](../../src/AIAgentPlatform.Infrastructure/Services/LiquidTemplateEngine.cs)

**Testing åƒè€ƒ**:
- ğŸ§ª [Prompt Generation Tests](../../tests/AIAgentPlatform.UnitTests/Application/PromptGeneration/)
- ğŸ§ª [Template Rendering Tests](../../tests/AIAgentPlatform.IntegrationTests/PromptTemplates/)

### US 2.2: Plugin ç†±é‡è¼‰æ©Ÿåˆ¶ (3 SP)

**ç›®æ¨™**: å¯¦ç¾é›¶åœæ©Ÿ Plugin ç†±æ›´æ–°ï¼Œæ”¯æ´å¤šç‰ˆæœ¬ä¸¦å­˜èˆ‡å„ªé›…åˆ‡æ›

#### US 2.2.1: MVP ç¯„åœå®šç¾©

**Must Have (Phase 1)**:
- âœ… **AssemblyLoadContext éš”é›¢**: æ¯å€‹ Plugin ç‰ˆæœ¬ç¨ç«‹ AssemblyLoadContextï¼Œé¿å…ç‰ˆæœ¬è¡çª
- âœ… **IPluginLoader å¯¦ä½œ**: å‹•æ…‹è¼‰å…¥èˆ‡å¸è¼‰ Plugin Assembly
- âœ… **ç‰ˆæœ¬ç®¡ç†**: å¤šç‰ˆæœ¬ä¸¦å­˜ï¼ˆv1.0.0 èˆ‡ v1.1.0 åŒæ™‚é‹è¡Œï¼‰
- âœ… **å„ªé›…åˆ‡æ›**: åŸ·è¡Œä¸­çš„ Agent å®Œæˆç•¶å‰ä»»å‹™å¾Œè‡ªå‹•åˆ‡æ›åˆ°æ–°ç‰ˆæœ¬
- âœ… **ç†±éƒ¨ç½² API**: ä¸Šå‚³æ–°ç‰ˆæœ¬ Plugin DLL ä¸¦è§¸ç™¼ç†±é‡è¼‰
- âœ… **å›æ»¾æ©Ÿåˆ¶**: ç†±æ›´æ–°å¤±æ•—æ™‚è‡ªå‹•å›æ»¾åˆ°èˆŠç‰ˆæœ¬

**Excluded (Phase 2)**:
- âŒ A/B Testing æ”¯æ´ (éƒ¨åˆ† Agent ä½¿ç”¨æ–°ç‰ˆæœ¬) - Phase 2
- âŒ ç‰ˆæœ¬ç›¸å®¹æ€§è‡ªå‹•æª¢æŸ¥ (API ç ´å£æ€§è®Šæ›´åµæ¸¬) - Phase 2
- âŒ ç†±æ›´æ–°æ•ˆæœç›£æ§èˆ‡åˆ†æ - Phase 2
- âŒ åˆ†æ•£å¼ç’°å¢ƒä¸‹çš„å¤šç¯€é»ç†±æ›´æ–°å”èª¿ - Phase 2

#### US 2.2.2: AssemblyLoadContext æ¶æ§‹è¨­è¨ˆ

**éš”é›¢ç­–ç•¥**:
```yaml
Plugin éš”é›¢å±¤ç´š:
  - æ¯å€‹ Plugin Name ä¸€å€‹å°ˆå±¬ AssemblyLoadContext
  - åŒä¸€å€‹ Plugin çš„ä¸åŒç‰ˆæœ¬å…±ç”¨ç›¸åŒ Context (é€éç‰ˆæœ¬åˆ‡æ›ç®¡ç†)
  - æ”¯æ´ Assembly å¸è¼‰ (éœ€ç¢ºä¿ç„¡å¼•ç”¨æ™‚æ‰å¸è¼‰)

ä¾è³´ç®¡ç†:
  - Plugin ä¾è³´çš„ç¬¬ä¸‰æ–¹å¥—ä»¶éš”é›¢è¼‰å…¥
  - å…±ç”¨æ¡†æ¶ä¾è³´ (Semantic Kernel, Microsoft.Extensions.*) ä½¿ç”¨ä¸» Context
  - é¿å…ä¾è³´è¡çªèˆ‡ç‰ˆæœ¬æ±¡æŸ“
```

**C# AssemblyLoadContext å¯¦ä½œ**:
```csharp
public sealed class PluginAssemblyLoadContext : AssemblyLoadContext
{
    private readonly AssemblyDependencyResolver _resolver;
    private readonly ILogger<PluginAssemblyLoadContext> _logger;

    public string PluginName { get; }
    public VersionNumber Version { get; }

    public PluginAssemblyLoadContext(
        string pluginName,
        VersionNumber version,
        string pluginPath,
        ILogger<PluginAssemblyLoadContext> logger)
        : base(name: $"{pluginName}_v{version}", isCollectible: true)
    {
        PluginName = pluginName;
        Version = version;
        _resolver = new AssemblyDependencyResolver(pluginPath);
        _logger = logger;
    }

    protected override Assembly? Load(AssemblyName assemblyName)
    {
        // å„ªå…ˆä½¿ç”¨ä¸» Context è¼‰å…¥å…±ç”¨æ¡†æ¶
        if (IsSharedFrameworkAssembly(assemblyName))
        {
            return null; // ç”±é è¨­ Context è¼‰å…¥
        }

        // ä½¿ç”¨ Resolver è§£æ Plugin ä¾è³´
        var assemblyPath = _resolver.ResolveAssemblyToPath(assemblyName);
        if (assemblyPath != null)
        {
            _logger.LogDebug(
                "Loading assembly {AssemblyName} for Plugin {PluginName} v{Version}",
                assemblyName.Name, PluginName, Version);
            return LoadFromAssemblyPath(assemblyPath);
        }

        return null;
    }

    protected override IntPtr LoadUnmanagedDll(string unmanagedDllName)
    {
        var libraryPath = _resolver.ResolveUnmanagedDllToPath(unmanagedDllName);
        return libraryPath != null
            ? LoadUnmanagedDllFromPath(libraryPath)
            : IntPtr.Zero;
    }

    private static bool IsSharedFrameworkAssembly(AssemblyName assemblyName)
    {
        var sharedPrefixes = new[]
        {
            "Microsoft.Extensions.",
            "Microsoft.SemanticKernel.",
            "System.",
            "Newtonsoft.Json"
        };

        return sharedPrefixes.Any(prefix =>
            assemblyName.Name?.StartsWith(prefix) == true);
    }
}
```

#### US 2.2.3: IPluginLoader æ ¸å¿ƒå¯¦ä½œ

**ä»‹é¢å®šç¾©**:
```csharp
public interface IPluginLoader
{
    /// <summary>
    /// è¼‰å…¥æŒ‡å®šç‰ˆæœ¬çš„ Plugin
    /// </summary>
    Task<Result<PluginLoadResult>> LoadPluginAsync(
        string pluginName,
        VersionNumber version,
        string assemblyPath,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// å¸è¼‰æŒ‡å®šç‰ˆæœ¬çš„ Plugin (å„ªé›…å¸è¼‰)
    /// </summary>
    Task<Result> UnloadPluginAsync(
        string pluginName,
        VersionNumber version,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// åˆ‡æ› Plugin ç‰ˆæœ¬ (åŸå­æ“ä½œ)
    /// </summary>
    Task<Result> SwitchPluginVersionAsync(
        string pluginName,
        VersionNumber fromVersion,
        VersionNumber toVersion,
        CancellationToken cancellationToken = default);

    /// <summary>
    /// å–å¾—ç›®å‰è¼‰å…¥çš„ Plugin ç‰ˆæœ¬æ¸…å–®
    /// </summary>
    IReadOnlyList<LoadedPluginInfo> GetLoadedPlugins();
}

public sealed record PluginLoadResult(
    string PluginName,
    VersionNumber Version,
    Assembly Assembly,
    PluginAssemblyLoadContext LoadContext,
    List<Type> PluginTypes);

public sealed record LoadedPluginInfo(
    string PluginName,
    VersionNumber Version,
    int ActiveAgentCount,
    DateTime LoadedAt);
```

**å¯¦ä½œé¡åˆ¥**:
```csharp
public sealed class PluginLoader : IPluginLoader, IDisposable
{
    private readonly ConcurrentDictionary<string, PluginVersionManager> _pluginManagers = new();
    private readonly IPluginActivator _activator;
    private readonly ILogger<PluginLoader> _logger;
    private readonly SemaphoreSlim _switchLock = new(1, 1);

    public async Task<Result<PluginLoadResult>> LoadPluginAsync(
        string pluginName,
        VersionNumber version,
        string assemblyPath,
        CancellationToken cancellationToken = default)
    {
        try
        {
            // Step 1: å»ºç«‹éš”é›¢çš„ AssemblyLoadContext
            var loadContext = new PluginAssemblyLoadContext(
                pluginName,
                version,
                assemblyPath,
                _logger);

            // Step 2: è¼‰å…¥ Assembly
            var assembly = loadContext.LoadFromAssemblyPath(assemblyPath);

            // Step 3: æƒæ Plugin é¡å‹
            var pluginTypes = ScanPluginTypes(assembly);
            if (pluginTypes.Count == 0)
            {
                loadContext.Unload();
                return Result<PluginLoadResult>.Failure(
                    $"No plugin types found in assembly {assemblyPath}");
            }

            // Step 4: è¨»å†Šåˆ°ç‰ˆæœ¬ç®¡ç†å™¨
            var manager = _pluginManagers.GetOrAdd(
                pluginName,
                _ => new PluginVersionManager(pluginName, _logger));

            manager.RegisterVersion(version, loadContext, pluginTypes);

            var result = new PluginLoadResult(
                pluginName,
                version,
                assembly,
                loadContext,
                pluginTypes);

            _logger.LogInformation(
                "Successfully loaded Plugin {PluginName} v{Version} with {TypeCount} types",
                pluginName, version, pluginTypes.Count);

            return Result<PluginLoadResult>.Success(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Failed to load Plugin {PluginName} v{Version} from {Path}",
                pluginName, version, assemblyPath);
            return Result<PluginLoadResult>.Failure(
                $"Plugin load failed: {ex.Message}");
        }
    }

    public async Task<Result> SwitchPluginVersionAsync(
        string pluginName,
        VersionNumber fromVersion,
        VersionNumber toVersion,
        CancellationToken cancellationToken = default)
    {
        await _switchLock.WaitAsync(cancellationToken);
        try
        {
            if (!_pluginManagers.TryGetValue(pluginName, out var manager))
            {
                return Result.Failure($"Plugin {pluginName} not found");
            }

            // Step 1: é©—è­‰ç›®æ¨™ç‰ˆæœ¬å·²è¼‰å…¥
            if (!manager.IsVersionLoaded(toVersion))
            {
                return Result.Failure($"Target version {toVersion} not loaded");
            }

            // Step 2: åˆ‡æ›æ´»å‹•ç‰ˆæœ¬ (åŸå­æ“ä½œ)
            manager.SwitchActiveVersion(toVersion);

            _logger.LogInformation(
                "Successfully switched Plugin {PluginName}: v{FromVersion} -> v{ToVersion}",
                pluginName, fromVersion, toVersion);

            // Step 3: éåŒæ­¥å¸è¼‰èˆŠç‰ˆæœ¬ (ç­‰å¾…æ‰€æœ‰ Agent å®Œæˆ)
            _ = Task.Run(async () =>
            {
                await Task.Delay(TimeSpan.FromMinutes(5), cancellationToken);
                await UnloadPluginAsync(pluginName, fromVersion, cancellationToken);
            }, cancellationToken);

            return Result.Success();
        }
        finally
        {
            _switchLock.Release();
        }
    }

    public async Task<Result> UnloadPluginAsync(
        string pluginName,
        VersionNumber version,
        CancellationToken cancellationToken = default)
    {
        if (!_pluginManagers.TryGetValue(pluginName, out var manager))
        {
            return Result.Failure($"Plugin {pluginName} not found");
        }

        // ç­‰å¾…æ‰€æœ‰ä½¿ç”¨æ­¤ç‰ˆæœ¬çš„ Agent å®Œæˆ
        var activeCount = manager.GetActiveAgentCount(version);
        if (activeCount > 0)
        {
            _logger.LogWarning(
                "Cannot unload Plugin {PluginName} v{Version}: {ActiveCount} agents still active",
                pluginName, version, activeCount);
            return Result.Failure("Plugin still in use");
        }

        // å¸è¼‰ AssemblyLoadContext
        manager.UnloadVersion(version);

        // è§¸ç™¼ GC ç¢ºä¿è³‡æºé‡‹æ”¾
        for (int i = 0; i < 3; i++)
        {
            GC.Collect();
            GC.WaitForPendingFinalizers();
        }

        _logger.LogInformation(
            "Successfully unloaded Plugin {PluginName} v{Version}",
            pluginName, version);

        return Result.Success();
    }

    private List<Type> ScanPluginTypes(Assembly assembly)
    {
        return assembly.GetTypes()
            .Where(t => t.IsClass && !t.IsAbstract)
            .Where(t => t.GetCustomAttribute<PluginAttribute>() != null)
            .ToList();
    }

    public void Dispose()
    {
        _switchLock?.Dispose();
    }
}
```

#### US 2.2.4: ç‰ˆæœ¬ç®¡ç†å™¨è¨­è¨ˆ

**PluginVersionManager é¡åˆ¥**:
```csharp
public sealed class PluginVersionManager
{
    private readonly string _pluginName;
    private readonly ConcurrentDictionary<VersionNumber, PluginVersionContext> _versions = new();
    private readonly ILogger _logger;
    private VersionNumber? _activeVersion;

    public PluginVersionManager(string pluginName, ILogger logger)
    {
        _pluginName = pluginName;
        _logger = logger;
    }

    public void RegisterVersion(
        VersionNumber version,
        PluginAssemblyLoadContext loadContext,
        List<Type> pluginTypes)
    {
        var context = new PluginVersionContext(
            version,
            loadContext,
            pluginTypes,
            DateTime.UtcNow);

        _versions[version] = context;
        _activeVersion ??= version; // é¦–æ¬¡è¨»å†Šè¨­ç‚ºæ´»å‹•ç‰ˆæœ¬
    }

    public void SwitchActiveVersion(VersionNumber newVersion)
    {
        if (!_versions.ContainsKey(newVersion))
            throw new InvalidOperationException($"Version {newVersion} not loaded");

        _activeVersion = newVersion;
    }

    public bool IsVersionLoaded(VersionNumber version)
        => _versions.ContainsKey(version);

    public int GetActiveAgentCount(VersionNumber version)
    {
        return _versions.TryGetValue(version, out var context)
            ? context.ActiveAgentCount
            : 0;
    }

    public void UnloadVersion(VersionNumber version)
    {
        if (_versions.TryRemove(version, out var context))
        {
            context.LoadContext.Unload();
        }
    }

    public VersionNumber? GetActiveVersion() => _activeVersion;

    public List<Type> GetActivePluginTypes()
    {
        if (_activeVersion == null)
            return new List<Type>();

        return _versions.TryGetValue(_activeVersion, out var context)
            ? context.PluginTypes
            : new List<Type>();
    }
}

public sealed record PluginVersionContext(
    VersionNumber Version,
    PluginAssemblyLoadContext LoadContext,
    List<Type> PluginTypes,
    DateTime LoadedAt)
{
    public int ActiveAgentCount { get; set; }
}
```

#### US 2.2.5: Backend API è¦æ ¼

**API Endpoint 1**: `POST /api/v1/plugins/{pluginName}/versions/{version}/hot-reload`

**Request**:
```json
{
  "assemblyFileId": "123e4567-e89b-12d3-a456-426614174000",
  "switchStrategy": "graceful",
  "rollbackOnFailure": true
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "data": {
    "pluginName": "WeatherPlugin",
    "newVersion": "1.1.0",
    "previousVersion": "1.0.0",
    "switchedAt": "2024-01-15T10:30:00Z",
    "affectedAgents": 5,
    "status": "completed"
  }
}
```

**API Endpoint 2**: `POST /api/v1/plugins/{pluginName}/versions/{version}/rollback`

**Request**:
```json
{
  "targetVersion": "1.0.0",
  "reason": "Performance regression detected"
}
```

**Response (200 OK)**:
```json
{
  "success": true,
  "data": {
    "pluginName": "WeatherPlugin",
    "rolledBackTo": "1.0.0",
    "rolledBackFrom": "1.1.0",
    "rolledBackAt": "2024-01-15T10:35:00Z"
  }
}
```

#### US 2.2.6: Application Layer è¨­è¨ˆ

**CQRS Command**:
```csharp
public sealed record HotReloadPluginCommand(
    string PluginName,
    VersionNumber NewVersion,
    Guid AssemblyFileId,
    SwitchStrategy Strategy) : IRequest<Result<HotReloadResultDto>>;

public sealed class HotReloadPluginCommandHandler
    : IRequestHandler<HotReloadPluginCommand, Result<HotReloadResultDto>>
{
    private readonly IPluginLoader _pluginLoader;
    private readonly IPluginVersionRepository _versionRepo;
    private readonly IFileStorageService _fileStorage;
    private readonly ILogger<HotReloadPluginCommandHandler> _logger;

    public async Task<Result<HotReloadResultDto>> Handle(
        HotReloadPluginCommand request,
        CancellationToken cancellationToken)
    {
        try
        {
            // Step 1: ä¸‹è¼‰ Assembly æª”æ¡ˆ
            var assemblyPath = await _fileStorage.DownloadFileAsync(
                request.AssemblyFileId,
                cancellationToken);

            // Step 2: è¼‰å…¥æ–°ç‰ˆæœ¬
            var loadResult = await _pluginLoader.LoadPluginAsync(
                request.PluginName,
                request.NewVersion,
                assemblyPath,
                cancellationToken);

            if (!loadResult.IsSuccess)
            {
                _logger.LogError("Failed to load new version: {Error}", loadResult.Error);
                return Result<HotReloadResultDto>.Failure(loadResult.Error);
            }

            // Step 3: å–å¾—èˆŠç‰ˆæœ¬
            var currentVersion = await _versionRepo.GetActiveVersionAsync(
                request.PluginName,
                cancellationToken);

            // Step 4: åˆ‡æ›ç‰ˆæœ¬
            var switchResult = await _pluginLoader.SwitchPluginVersionAsync(
                request.PluginName,
                currentVersion,
                request.NewVersion,
                cancellationToken);

            if (!switchResult.IsSuccess)
            {
                _logger.LogError("Failed to switch version: {Error}", switchResult.Error);
                // å›æ»¾ï¼šå¸è¼‰æ–°ç‰ˆæœ¬
                await _pluginLoader.UnloadPluginAsync(
                    request.PluginName,
                    request.NewVersion,
                    cancellationToken);
                return Result<HotReloadResultDto>.Failure(switchResult.Error);
            }

            // Step 5: æ›´æ–°è³‡æ–™åº«æ´»å‹•ç‰ˆæœ¬
            await _versionRepo.SetActiveVersionAsync(
                request.PluginName,
                request.NewVersion,
                cancellationToken);

            var result = new HotReloadResultDto
            {
                PluginName = request.PluginName,
                NewVersion = request.NewVersion.ToString(),
                PreviousVersion = currentVersion.ToString(),
                SwitchedAt = DateTime.UtcNow,
                Status = "completed"
            };

            return Result<HotReloadResultDto>.Success(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Hot reload failed for Plugin {PluginName}", request.PluginName);
            return Result<HotReloadResultDto>.Failure($"Hot reload failed: {ex.Message}");
        }
    }
}
```

#### US 2.2.7: åƒè€ƒæ–‡ä»¶

**Architecture åƒè€ƒ**:
- ğŸ“ [AssemblyLoadContext Documentation](https://learn.microsoft.com/en-us/dotnet/core/dependency-loading/understanding-assemblyloadcontext)
- ğŸ“ [Plugin Hot Reload ADR](../../docs/architecture/adr/ADR-009-plugin-hot-reload.md)
- ğŸ“ [Version Management Strategy](../../docs/technical-implementation/01-backend-net9/09-plugin-versioning.md)

**Implementation åƒè€ƒ**:
- ğŸ”¨ [IPluginLoader Interface](../../src/AIAgentPlatform.Application/Interfaces/IPluginLoader.cs)
- ğŸ”¨ [PluginLoader Service](../../src/AIAgentPlatform.Infrastructure/Services/PluginLoader.cs)
- ğŸ”¨ [PluginVersionManager](../../src/AIAgentPlatform.Infrastructure/Services/PluginVersionManager.cs)

**Testing åƒè€ƒ**:
- ğŸ§ª [Plugin Hot Reload Tests](../../tests/AIAgentPlatform.IntegrationTests/PluginHotReload/)
- ğŸ§ª [AssemblyLoadContext Tests](../../tests/AIAgentPlatform.UnitTests/Infrastructure/Services/PluginLoaderTests.cs)

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæŠ€è¡“å¯¦æ–½æ–¹æ¡ˆ (How to Build)

**å®Œæ•´æŠ€è¡“æ–‡æª”**: [Backend Technical Guide](../../docs/technical-implementation/01-backend-net9/README.md)

### Backend å¯¦æ–½

#### Clean Architecture ç›®éŒ„çµæ§‹

**æ¶æ§‹è¨­è¨ˆåƒè€ƒ**:
- ğŸ—ï¸ [ADR-001: Clean Architecture](../../docs/architecture/adr/ADR-001-clean-architecture.md) - æ¶æ§‹åˆ†å±¤æ±ºç­–
- ğŸ—ï¸ [Monorepo Setup](../../docs/technical-implementation/01-backend-net9/01-monorepo-setup.md) - å°ˆæ¡ˆçµæ§‹

```
AIAgentPlatform.sln
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ AIAgentPlatform.Domain/                     # é ˜åŸŸå±¤ (ä¸ä¾è³´ä»»ä½•å¤–éƒ¨å±¤)
â”‚   â”‚   â”œâ”€â”€ Entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ Persona.cs                          # Persona å¯¦é«” (US 7.1)
â”‚   â”‚   â”‚   â”œâ”€â”€ PersonaTemplate.cs                  # Persona æ¨¡æ¿å¯¦é«”
â”‚   â”‚   â”‚   â”œâ”€â”€ PromptTemplate.cs                   # Prompt æ¨¡æ¿å¯¦é«” (US 7.2)
â”‚   â”‚   â”‚   â”œâ”€â”€ PluginVersion.cs                    # Plugin ç‰ˆæœ¬å¯¦é«” (US 2.2)
â”‚   â”‚   â”‚   â””â”€â”€ PluginVersionHistory.cs             # Plugin ç‰ˆæœ¬æ­·å²
â”‚   â”‚   â”œâ”€â”€ ValueObjects/
â”‚   â”‚   â”‚   â”œâ”€â”€ PersonaConfig.cs                    # Persona é…ç½® VO
â”‚   â”‚   â”‚   â”œâ”€â”€ CommunicationStyle.cs               # æºé€šé¢¨æ ¼ VO
â”‚   â”‚   â”‚   â”œâ”€â”€ ResponsePattern.cs                  # å›æ‡‰æ¨¡å¼ VO
â”‚   â”‚   â”‚   â”œâ”€â”€ SafetyGuardrails.cs                 # å®‰å…¨å®ˆå‰‡ VO
â”‚   â”‚   â”‚   â””â”€â”€ VersionNumber.cs                    # ç‰ˆæœ¬è™Ÿ VO
â”‚   â”‚   â””â”€â”€ Interfaces/
â”‚   â”‚       â”œâ”€â”€ IPersonaRepository.cs
â”‚   â”‚       â”œâ”€â”€ IPromptTemplateRepository.cs
â”‚   â”‚       â””â”€â”€ IPluginVersionRepository.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ AIAgentPlatform.Application/                # æ‡‰ç”¨å±¤ (ä¾è³´ Domain)
â”‚   â”‚   â”œâ”€â”€ Personas/
â”‚   â”‚   â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreatePersona/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreatePersonaCommand.cs
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreatePersonaCommandHandler.cs
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CreatePersonaCommandValidator.cs
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UpdatePersona/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UpdatePersonaCommand.cs
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UpdatePersonaCommandHandler.cs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DeletePersona/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DeletePersonaCommand.cs
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ DeletePersonaCommandHandler.cs
â”‚   â”‚   â”‚   â””â”€â”€ Queries/
â”‚   â”‚   â”‚       â”œâ”€â”€ GetPersonaById/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ GetPersonaByIdQuery.cs
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ GetPersonaByIdQueryHandler.cs
â”‚   â”‚   â”‚       â””â”€â”€ GetPersonasList/
â”‚   â”‚   â”‚           â”œâ”€â”€ GetPersonasQuery.cs
â”‚   â”‚   â”‚           â””â”€â”€ GetPersonasQueryHandler.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ PromptGeneration/
â”‚   â”‚   â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GeneratePrompt/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GeneratePromptCommand.cs
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ GeneratePromptCommandHandler.cs
â”‚   â”‚   â”‚   â””â”€â”€ Queries/
â”‚   â”‚   â”‚       â””â”€â”€ GetPromptTemplates/
â”‚   â”‚   â”‚           â”œâ”€â”€ GetPromptTemplatesQuery.cs
â”‚   â”‚   â”‚           â””â”€â”€ GetPromptTemplatesQueryHandler.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ PluginVersions/
â”‚   â”‚   â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HotReloadPlugin/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HotReloadPluginCommand.cs
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HotReloadPluginCommandHandler.cs
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ RollbackPlugin/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ RollbackPluginCommand.cs
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ RollbackPluginCommandHandler.cs
â”‚   â”‚   â”‚   â””â”€â”€ Queries/
â”‚   â”‚   â”‚       â””â”€â”€ GetPluginVersions/
â”‚   â”‚   â”‚           â”œâ”€â”€ GetPluginVersionsQuery.cs
â”‚   â”‚   â”‚           â””â”€â”€ GetPluginVersionsQueryHandler.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Interfaces/
â”‚   â”‚       â”œâ”€â”€ IPromptGenerationService.cs
â”‚   â”‚       â”œâ”€â”€ IPluginLoader.cs
â”‚   â”‚       â”œâ”€â”€ IPluginActivator.cs
â”‚   â”‚       â””â”€â”€ ITokenCounter.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ AIAgentPlatform.Infrastructure/             # åŸºç¤è¨­æ–½å±¤ (ä¾è³´ Application)
â”‚   â”‚   â”œâ”€â”€ Persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ ApplicationDbContext.cs             # EF Core DbContext
â”‚   â”‚   â”‚   â”œâ”€â”€ Configurations/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PersonaConfiguration.cs         # Persona å¯¦é«”é…ç½®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PromptTemplateConfiguration.cs  # PromptTemplate é…ç½®
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PluginVersionConfiguration.cs   # PluginVersion é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ Repositories/
â”‚   â”‚   â”‚       â”œâ”€â”€ PersonaRepository.cs
â”‚   â”‚   â”‚       â”œâ”€â”€ PromptTemplateRepository.cs
â”‚   â”‚   â”‚       â””â”€â”€ PluginVersionRepository.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”‚   â”œâ”€â”€ PromptGenerationService.cs          # Prompt ç”Ÿæˆæœå‹™
â”‚   â”‚   â”‚   â”œâ”€â”€ LiquidTemplateEngine.cs             # Liquid æ¨¡æ¿å¼•æ“å°è£
â”‚   â”‚   â”‚   â”œâ”€â”€ TikTokenCounter.cs                  # Token è¨ˆæ•¸æœå‹™
â”‚   â”‚   â”‚   â”œâ”€â”€ PluginLoader.cs                     # Plugin å‹•æ…‹è¼‰å…¥
â”‚   â”‚   â”‚   â”œâ”€â”€ PluginActivator.cs                  # Plugin å¯¦ä¾‹åŒ–
â”‚   â”‚   â”‚   â””â”€â”€ PluginVersionManager.cs             # Plugin ç‰ˆæœ¬ç®¡ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Migrations/                             # EF Core Migrations
â”‚   â”‚       â””â”€â”€ 20250115_AddPersonaAndPlugin.cs
â”‚   â”‚
â”‚   â””â”€â”€ AIAgentPlatform.API/                        # API å±¤ (æœ€å¤–å±¤)
â”‚       â”œâ”€â”€ Controllers/
â”‚       â”‚   â”œâ”€â”€ PersonasController.cs               # Persona CRUD API
â”‚       â”‚   â”œâ”€â”€ PromptGenerationController.cs       # Prompt ç”Ÿæˆ API
â”‚       â”‚   â””â”€â”€ PluginVersionsController.cs         # Plugin ç‰ˆæœ¬ç®¡ç† API
â”‚       â””â”€â”€ Program.cs                              # ä¾è³´æ³¨å…¥é…ç½®
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ AIAgentPlatform.UnitTests/
    â”‚   â”œâ”€â”€ Domain/
    â”‚   â”‚   â”œâ”€â”€ PersonaTests.cs
    â”‚   â”‚   â””â”€â”€ ValueObjects/
    â”‚   â”‚       â”œâ”€â”€ PersonaConfigTests.cs
    â”‚   â”‚       â””â”€â”€ VersionNumberTests.cs
    â”‚   â”œâ”€â”€ Application/
    â”‚   â”‚   â”œâ”€â”€ Personas/
    â”‚   â”‚   â”‚   â”œâ”€â”€ CreatePersonaCommandHandlerTests.cs
    â”‚   â”‚   â”‚   â””â”€â”€ GetPersonaByIdQueryHandlerTests.cs
    â”‚   â”‚   â””â”€â”€ PromptGeneration/
    â”‚   â”‚       â””â”€â”€ GeneratePromptCommandHandlerTests.cs
    â”‚   â””â”€â”€ Infrastructure/
    â”‚       â”œâ”€â”€ Services/
    â”‚       â”‚   â”œâ”€â”€ PromptGenerationServiceTests.cs
    â”‚       â”‚   â”œâ”€â”€ PluginLoaderTests.cs
    â”‚       â”‚   â””â”€â”€ PluginActivatorTests.cs
    â”‚       â””â”€â”€ Repositories/
    â”‚           â””â”€â”€ PersonaRepositoryTests.cs
    â”‚
    â””â”€â”€ AIAgentPlatform.IntegrationTests/
        â”œâ”€â”€ Personas/
        â”‚   â””â”€â”€ PersonasControllerTests.cs
        â”œâ”€â”€ PromptGeneration/
        â”‚   â””â”€â”€ PromptGenerationControllerTests.cs
        â””â”€â”€ PluginHotReload/
            â””â”€â”€ PluginHotReloadTests.cs
```

**åˆ†å±¤è¨­è¨ˆåƒè€ƒ**:
- ğŸ“ [Domain Layer Design](../../docs/technical-implementation/01-backend-net9/07-domain-layer.md)
- ğŸ“ [Application Layer Design](../../docs/technical-implementation/01-backend-net9/05-cqrs-implementation.md)
- ğŸ“ [Infrastructure Layer Design](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md)
- ğŸ“ [API Layer Design](../../docs/technical-implementation/01-backend-net9/08-api-layer.md)

#### æ ¸å¿ƒå¯¦æ–½ç­–ç•¥

**æ¶æ§‹æ¨¡å¼åƒè€ƒ**:
- ğŸ“š [Architecture Design Document](../../docs/architecture/Architecture-Design-Document.md) - å®Œæ•´æ¶æ§‹è¨­è¨ˆ

**1. CQRS with MediatR**:
- Commands: å‰µå»º, æ›´æ–°, åˆªé™¤ Persona, ç”Ÿæˆ Prompt, Plugin ç†±é‡è¼‰ (å¯«å…¥æ“ä½œ)
- Queries: æŸ¥è©¢ Persona, æŸ¥è©¢ Prompt æ¨¡æ¿, æŸ¥è©¢ Plugin ç‰ˆæœ¬ (è®€å–æ“ä½œ)
- å¥½è™•: é—œæ³¨é»åˆ†é›¢, æ˜“æ–¼æ¸¬è©¦, æ”¯æ´è¤‡é›œæ¥­å‹™é‚è¼¯

**åƒè€ƒ**:
- ğŸ“ [ADR-002: CQRS Pattern](../../docs/architecture/adr/ADR-002-cqrs-pattern.md) - CQRS æ¶æ§‹æ±ºç­–
- ğŸ“ [CQRS Implementation](../../docs/technical-implementation/01-backend-net9/05-cqrs-implementation.md) - MediatR å¯¦ä½œæŒ‡å—
- ğŸ“ [Pipeline Behaviors](../../docs/technical-implementation/01-backend-net9/05-cqrs-implementation.md#pipeline-behaviors)

**MediatR é…ç½®ç¯„ä¾‹**:
```csharp
// Program.cs - MediatR è¨»å†Š
builder.Services.AddMediatR(cfg => {
    cfg.RegisterServicesFromAssembly(typeof(CreatePersonaCommand).Assembly);
    cfg.AddBehavior(typeof(IPipelineBehavior<,>), typeof(ValidationBehavior<,>));
    cfg.AddBehavior(typeof(IPipelineBehavior<,>), typeof(LoggingBehavior<,>));
});
```

**2. Repository Pattern + Unit of Work**:
- PersonaRepository: å°è£ Persona è³‡æ–™å­˜å–
- PromptTemplateRepository: ç®¡ç† Prompt æ¨¡æ¿
- PluginVersionRepository: ç®¡ç† Plugin ç‰ˆæœ¬æ­·å²
- å¥½è™•: éš”é›¢æ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™å­˜å–å¯¦ç¾, å¯æ›¿æ›è³‡æ–™ä¾†æº

**åƒè€ƒ**:
- ğŸ“ [ADR-003: Repository Pattern](../../docs/architecture/adr/ADR-003-repository-pattern.md) - Repository æ¶æ§‹æ±ºç­–
- ğŸ“ [Data Access Layer](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md) - Repository å¯¦ä½œ
- ğŸ“ [Generic Repository](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md#generic-repository)

**3. FluentValidation**:
- Persona é…ç½®é©—è­‰: é©—è­‰ JSON Schema, å¿…å¡«æ¬„ä½, è³‡æ–™ç¯„åœ
- Plugin ç‰ˆæœ¬é©—è­‰: SemVer æ ¼å¼é©—è­‰, ç‰ˆæœ¬è¡çªæª¢æŸ¥
- å¥½è™•: é©—è­‰èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢, å¯è®€æ€§é«˜, æ˜“æ–¼ç¶­è­·

**åƒè€ƒ**:
- ğŸ“ [Validation Strategy](../../docs/technical-implementation/01-backend-net9/06-validation-strategy.md) - FluentValidation å¯¦ä½œ
- ğŸ“ [Complex Validation Rules](../../docs/technical-implementation/01-backend-net9/06-validation-strategy.md#complex-rules)

**FluentValidation ç¯„ä¾‹**:
```csharp
public sealed class CreatePersonaCommandValidator : AbstractValidator<CreatePersonaCommand>
{
    public CreatePersonaCommandValidator()
    {
        RuleFor(x => x.Name)
            .NotEmpty().WithMessage("Persona name is required")
            .MaximumLength(50).WithMessage("Name cannot exceed 50 characters");

        RuleFor(x => x.Role)
            .NotEmpty().WithMessage("Role is required")
            .MaximumLength(100);

        RuleFor(x => x.Config)
            .NotNull().WithMessage("Persona config is required")
            .SetValidator(new PersonaConfigValidator());
    }
}
```

**4. Entity Framework Core 9**:
- Code-First Migration: è³‡æ–™åº«çµæ§‹ç‰ˆæœ¬æ§åˆ¶
- LINQ æŸ¥è©¢: å¼·å‹åˆ¥æŸ¥è©¢, IntelliSense æ”¯æ´
- JSONB æ”¯æ´: PersonaConfig å„²å­˜ç‚º JSONB (PostgreSQL)
- è‡ªå‹•è¿½è¹¤è®Šæ›´: è‡ªå‹•åµæ¸¬å¯¦é«”ç‹€æ…‹è®ŠåŒ–

**åƒè€ƒ**:
- ğŸ“ [Data Access Layer](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md#ef-core-configuration)
- ğŸ“ [Migration Strategy](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md#ef-core-migrations)
- ğŸ“ [JSONB Column Configuration](../../docs/technical-implementation/01-backend-net9/04-data-access-layer.md#jsonb-support)

**EF Core é…ç½®ç¯„ä¾‹**:
```csharp
// PersonaConfiguration.cs
public sealed class PersonaConfiguration : IEntityTypeConfiguration<Persona>
{
    public void Configure(EntityTypeBuilder<Persona> builder)
    {
        builder.ToTable("personas");

        builder.HasKey(p => p.Id);

        builder.Property(p => p.Name)
            .HasMaxLength(50)
            .IsRequired();

        builder.Property(p => p.Role)
            .HasMaxLength(100)
            .IsRequired();

        // JSONB é…ç½®
        builder.Property(p => p.Config)
            .HasColumnType("jsonb")
            .HasConversion(
                v => JsonSerializer.Serialize(v, (JsonSerializerOptions)null),
                v => JsonSerializer.Deserialize<PersonaConfig>(v, (JsonSerializerOptions)null));

        builder.HasIndex(p => p.Name);
        builder.HasIndex(p => p.Role);
    }
}
```

**5. Liquid Template Engine**:
- Fluid Library: .NET Liquid æ¨¡æ¿å¼•æ“å¯¦ä½œ
- æ¨¡æ¿å¿«å–: è§£æå¾Œçš„æ¨¡æ¿å¿«å–åˆ°è¨˜æ†¶é«”
- å®‰å…¨æ¨¡å¼: é™åˆ¶æ¨¡æ¿ä¸­çš„å¯åŸ·è¡Œç¨‹å¼ç¢¼

**åƒè€ƒ**:
- ğŸ“ [Prompt Engineering](../../docs/technical-implementation/03-ai-integration/01-prompt-engineering.md)
- ğŸ“ [Template Engine Integration](../../docs/technical-implementation/03-ai-integration/01-prompt-engineering.md#liquid-templates)

**Fluid é…ç½®ç¯„ä¾‹**:
```csharp
// Program.cs - Fluid è¨»å†Š
builder.Services.AddSingleton<IFluidParser>(sp =>
{
    var parser = new FluidParser();
    // è¨»å†Šè‡ªå®šç¾©éæ¿¾å™¨
    TemplateContext.GlobalMemberAccessStrategy.Register<PersonaConfig>();
    return parser;
});

// LiquidTemplateEngine.cs
public sealed class LiquidTemplateEngine : ITemplateEngine
{
    private readonly IFluidParser _parser;
    private readonly MemoryCache _cache;

    public async Task<string> RenderAsync(
        string template,
        Dictionary<string, object> variables,
        CancellationToken cancellationToken)
    {
        // 1. å¾å¿«å–å–å¾—æˆ–è§£ææ¨¡æ¿
        var parsedTemplate = _cache.GetOrCreate(template, entry =>
        {
            entry.SlidingExpiration = TimeSpan.FromHours(1);
            return _parser.Parse(template);
        });

        // 2. å»ºç«‹ Template Context
        var context = new TemplateContext(variables);

        // 3. æ¸²æŸ“æ¨¡æ¿
        return await parsedTemplate.RenderAsync(context);
    }
}
```

**6. AssemblyLoadContext (Plugin ç†±é‡è¼‰)**:
- éš”é›¢è¼‰å…¥: æ¯å€‹ Plugin ç‰ˆæœ¬ç¨ç«‹ Context
- å¯å¸è¼‰: æ”¯æ´ GC å›æ”¶èˆŠç‰ˆæœ¬
- ä¾è³´è§£æ: AssemblyDependencyResolver è‡ªå‹•è§£æä¾è³´

**åƒè€ƒ**:
- ğŸ“ [ADR-009: Plugin Hot Reload](../../docs/architecture/adr/ADR-009-plugin-hot-reload.md)
- ğŸ“ [AssemblyLoadContext Best Practices](https://learn.microsoft.com/en-us/dotnet/core/dependency-loading/understanding-assemblyloadcontext)
- ğŸ“ [Plugin Versioning Strategy](../../docs/technical-implementation/01-backend-net9/09-plugin-versioning.md)

### Frontend å¯¦æ–½

**Frontend æ¶æ§‹å®Œæ•´æ–‡æª”**: [Frontend Technical Guide](../../docs/technical-implementation/02-frontend-react/README.md)

**Sprint 4 é‡é»**: ç”±æ–¼ Sprint 4 ä¸»è¦å°ˆæ³¨æ–¼ Backend åŠŸèƒ½ï¼ŒFrontend åƒ…éœ€åŸºç¤ API æ•´åˆèˆ‡ç°¡å–® UIï¼Œå®Œæ•´çš„ Persona ç®¡ç† UI å°‡åœ¨ Sprint 5 (US 8.1) å¯¦ä½œã€‚

#### ç›®éŒ„çµæ§‹

**å‰ç«¯æ¶æ§‹åƒè€ƒ**:
- ğŸ¨ [Frontend Architecture](../../docs/technical-implementation/02-frontend-react/01-frontend-architecture.md) - React æ¶æ§‹è¨­è¨ˆ
- ğŸ¨ [Project Structure](../../docs/technical-implementation/02-frontend-react/01-frontend-architecture.md#project-structure)

```
apps/web-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â””â”€â”€ personas/                       # Persona åŠŸèƒ½æ¨¡çµ„ (Sprint 4 åŸºç¤ç‰ˆ)
â”‚   â”‚       â”œâ”€â”€ components/
â”‚   â”‚       â”‚   â”œâ”€â”€ PersonaList.tsx         # Persona åˆ—è¡¨çµ„ä»¶
â”‚   â”‚       â”‚   â”œâ”€â”€ PersonaCard.tsx         # Persona å¡ç‰‡
â”‚   â”‚       â”‚   â””â”€â”€ PersonaBasicForm.tsx    # åŸºç¤ CRUD è¡¨å–®
â”‚   â”‚       â”œâ”€â”€ hooks/
â”‚   â”‚       â”‚   â””â”€â”€ usePersonas.ts          # React Query hooks
â”‚   â”‚       â””â”€â”€ services/
â”‚   â”‚           â””â”€â”€ personaService.ts       # API èª¿ç”¨å°è£
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                         # å…±ç”¨çµ„ä»¶
â”‚   â”‚   â””â”€â”€ common/
â”‚   â”‚       â”œâ”€â”€ LoadingSpinner.tsx
â”‚   â”‚       â””â”€â”€ ErrorBoundary.tsx
â”‚   â”‚
â”‚   â””â”€â”€ types/                              # TypeScript é¡å‹
â”‚       â””â”€â”€ persona.ts                      # Persona é¡å‹å®šç¾©
```

**çµ„ä»¶è¨­è¨ˆåƒè€ƒ**:
- ğŸ¨ [Component Design](../../docs/technical-implementation/02-frontend-react/02-component-design.md)
- ğŸ¨ [Component Library](../../docs/ux-design/design-system/component-library.md)

#### API æ•´åˆç­–ç•¥

**React Query é…ç½®**:
```typescript
// hooks/usePersonas.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { personaService } from '../services/personaService';

export const usePersonas = () => {
  return useQuery({
    queryKey: ['personas'],
    queryFn: () => personaService.getAll(),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
};

export const useCreatePersona = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: personaService.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['personas'] });
    },
  });
};
```

**API Service å°è£**:
```typescript
// services/personaService.ts
import { apiClient } from '@/services/apiClient';
import type { Persona, CreatePersonaRequest } from '@/types/persona';

export const personaService = {
  getAll: async (): Promise<Persona[]> => {
    const response = await apiClient.get<Persona[]>('/api/v1/personas');
    return response.data;
  },

  getById: async (id: string): Promise<Persona> => {
    const response = await apiClient.get<Persona>(`/api/v1/personas/${id}`);
    return response.data;
  },

  create: async (request: CreatePersonaRequest): Promise<Persona> => {
    const response = await apiClient.post<Persona>('/api/v1/personas', request);
    return response.data;
  },

  update: async (id: string, request: Partial<CreatePersonaRequest>): Promise<Persona> => {
    const response = await apiClient.put<Persona>(`/api/v1/personas/${id}`, request);
    return response.data;
  },

  delete: async (id: string): Promise<void> => {
    await apiClient.delete(`/api/v1/personas/${id}`);
  },
};
```

**åƒè€ƒ**:
- ğŸ¨ [Data Fetching Strategy](../../docs/technical-implementation/02-frontend-react/05-data-fetching.md) - React Query å¯¦ä½œ
- ğŸ¨ [API Client Configuration](../../docs/technical-implementation/02-frontend-react/05-data-fetching.md#api-client)

#### åŸºç¤ UI çµ„ä»¶

**PersonaList çµ„ä»¶**:
```typescript
// components/PersonaList.tsx
export const PersonaList: React.FC = () => {
  const { data: personas, isLoading, error } = usePersonas();

  if (isLoading) return <LoadingSpinner />;
  if (error) return <ErrorMessage error={error} />;

  return (
    <div className="persona-list">
      {personas?.map((persona) => (
        <PersonaCard key={persona.id} persona={persona} />
      ))}
    </div>
  );
};
```

**åƒè€ƒ**:
- ğŸ¨ [Component Testing Guidelines](../../docs/testing/testing-strategy.md#component-testing)

#### TypeScript é¡å‹å®šç¾©

```typescript
// types/persona.ts
export interface Persona {
  id: string;
  name: string;
  role: string;
  description?: string;
  config: PersonaConfig;
  isTemplate: boolean;
  isActive: boolean;
  createdAt: string;
  updatedAt: string;
}

export interface PersonaConfig {
  expertise: string[];
  communicationStyle: CommunicationStyle;
  responsePattern: ResponsePattern;
  safetyGuardrails: SafetyGuardrails;
}

export interface CommunicationStyle {
  formality: 'casual' | 'professional' | 'formal';
  verbosity: 'concise' | 'balanced' | 'detailed';
  tone: 'neutral' | 'encouraging' | 'authoritative';
}

export interface CreatePersonaRequest {
  name: string;
  role: string;
  description?: string;
  config: PersonaConfig;
}
```

**åƒè€ƒ**:
- ğŸ¨ [TypeScript Best Practices](../../docs/technical-implementation/02-frontend-react/06-typescript-practices.md)

### æ¸¬è©¦ç­–ç•¥

**æ¸¬è©¦ç­–ç•¥å®Œæ•´æ–‡æª”**: [Testing Strategy](../../docs/testing/testing-strategy.md)

#### Backend æ¸¬è©¦

**Backend æ¸¬è©¦æŒ‡å—**: [Backend Testing Guidelines](../../docs/testing/unit-testing-guidelines.md)

**1. å–®å…ƒæ¸¬è©¦** (ç›®æ¨™: 60 tests, â‰¥85% è¦†è“‹ç‡):

**Domain Layer æ¸¬è©¦**:
- Persona Entity æ¸¬è©¦ (8 tests)
  - Persona å‰µå»ºé©—è­‰
  - Persona é…ç½®æ›´æ–°
  - Persona ç‹€æ…‹åˆ‡æ› (å•Ÿç”¨/åœç”¨)
- Value Objects æ¸¬è©¦ (12 tests)
  - PersonaConfig é©—è­‰
  - CommunicationStyle é©—è­‰
  - VersionNumber æ ¼å¼é©—è­‰

**Application Layer æ¸¬è©¦**:
- Command Handlers æ¸¬è©¦ (15 tests)
  - CreatePersonaCommandHandler (æˆåŠŸ/å¤±æ•—æƒ…å¢ƒ)
  - UpdatePersonaCommandHandler (éƒ¨åˆ†æ›´æ–°/å®Œæ•´æ›´æ–°)
  - GeneratePromptCommandHandler (å¿«å–å‘½ä¸­/æœªå‘½ä¸­)
  - HotReloadPluginCommandHandler (æˆåŠŸ/å›æ»¾)
- Query Handlers æ¸¬è©¦ (8 tests)
  - GetPersonaByIdQuery (å­˜åœ¨/ä¸å­˜åœ¨)
  - GetPersonasQuery (ç¯©é¸/æ’åº)
- Validators æ¸¬è©¦ (10 tests)
  - CreatePersonaCommandValidator (å„ç¨®é©—è­‰è¦å‰‡)
  - PersonaConfigValidator (JSON Schema é©—è­‰)

**Infrastructure Layer æ¸¬è©¦**:
- Services æ¸¬è©¦ (12 tests)
  - PromptGenerationService (æ¨¡æ¿æ¸²æŸ“/Token è¨ˆæ•¸)
  - PluginLoader (è¼‰å…¥/å¸è¼‰/åˆ‡æ›ç‰ˆæœ¬)
  - TikTokenCounter (Token è¨ˆæ•¸æº–ç¢ºæ€§)
- Repositories æ¸¬è©¦ (5 tests, ä½¿ç”¨ In-Memory Database)
  - PersonaRepository CRUD æ“ä½œ
  - JSONB åºåˆ—åŒ–/ååºåˆ—åŒ–

**æ¸¬è©¦å·¥å…·**:
- xUnit - æ¸¬è©¦æ¡†æ¶
- Moq - Mocking Library
- FluentAssertions - æ–·è¨€åº«
- AutoFixture - æ¸¬è©¦è³‡æ–™ç”¢ç”Ÿ

**åƒè€ƒ**:
- ğŸ§ª [Unit Testing Guidelines](../../docs/testing/unit-testing-guidelines.md)
- ğŸ§ª [Mocking Strategy](../../docs/testing/unit-testing-guidelines.md#mocking-strategy)
- ğŸ§ª [Test Coverage Requirements](../../docs/testing/testing-strategy.md#coverage-requirements)

**å–®å…ƒæ¸¬è©¦ç¯„ä¾‹**:
```csharp
// CreatePersonaCommandHandlerTests.cs
public sealed class CreatePersonaCommandHandlerTests
{
    private readonly Mock<IPersonaRepository> _mockRepo;
    private readonly CreatePersonaCommandHandler _handler;

    [Fact]
    public async Task Handle_ValidCommand_ReturnsSuccessResult()
    {
        // Arrange
        var command = new CreatePersonaCommand(
            Name: "Alice",
            Role: "Cloud Architect",
            Config: CreateValidPersonaConfig()
        );

        _mockRepo.Setup(r => r.AddAsync(It.IsAny<Persona>(), default))
            .ReturnsAsync(Result.Success());

        // Act
        var result = await _handler.Handle(command, default);

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.Name.Should().Be("Alice");
        _mockRepo.Verify(r => r.AddAsync(It.IsAny<Persona>(), default), Times.Once);
    }
}
```

**2. é›†æˆæ¸¬è©¦** (ç›®æ¨™: 18 tests, â‰¥80% è¦†è“‹ç‡):

**API ç«¯é»æ¸¬è©¦**:
- Persona API æ¸¬è©¦ (8 tests)
  - POST /api/v1/personas (å‰µå»ºæˆåŠŸ/é©—è­‰å¤±æ•—)
  - GET /api/v1/personas (åˆ—è¡¨æŸ¥è©¢/ç¯©é¸)
  - PUT /api/v1/personas/{id} (æ›´æ–°æˆåŠŸ/ä¸å­˜åœ¨)
  - DELETE /api/v1/personas/{id} (åˆªé™¤æˆåŠŸ/ä¸å­˜åœ¨)
- Prompt Generation API æ¸¬è©¦ (5 tests)
  - POST /api/v1/personas/{id}/prompts/generate (æˆåŠŸ/Token è¶…é™)
- Plugin Hot Reload API æ¸¬è©¦ (5 tests)
  - POST /api/v1/plugins/{name}/versions/{version}/hot-reload (æˆåŠŸ/å›æ»¾)
  - POST /api/v1/plugins/{name}/versions/{version}/rollback

**è³‡æ–™åº«æ“ä½œæ¸¬è©¦**:
- EF Core JSONB æ“ä½œ (åºåˆ—åŒ–/ååºåˆ—åŒ–)
- Migration é©—è­‰ (è³‡æ–™åº«çµæ§‹æ­£ç¢ºæ€§)

**æ¸¬è©¦å·¥å…·**:
- WebApplicationFactory - API æ¸¬è©¦
- Testcontainers - PostgreSQL å®¹å™¨
- xUnit - æ¸¬è©¦æ¡†æ¶

**åƒè€ƒ**:
- ğŸ§ª [Integration Testing Guidelines](../../docs/testing/integration-testing-guidelines.md)
- ğŸ§ª [API Testing Strategy](../../docs/testing/integration-testing-guidelines.md#api-testing)
- ğŸ§ª [Database Testing](../../docs/testing/integration-testing-guidelines.md#database-testing)

**é›†æˆæ¸¬è©¦ç¯„ä¾‹**:
```csharp
// PersonasControllerTests.cs
public sealed class PersonasControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    [Fact]
    public async Task CreatePersona_ValidRequest_ReturnsCreated()
    {
        // Arrange
        var request = new CreatePersonaRequest(
            Name: "Alice",
            Role: "Cloud Architect",
            Config: CreateValidPersonaConfig()
        );

        // Act
        var response = await _client.PostAsJsonAsync("/api/v1/personas", request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Created);
        var persona = await response.Content.ReadFromJsonAsync<PersonaDto>();
        persona.Name.Should().Be("Alice");
    }
}
```

#### Frontend æ¸¬è©¦

**Frontend æ¸¬è©¦æŒ‡å—**: [Frontend Testing Guidelines](../../docs/testing/testing-strategy.md#frontend-testing)

**1. çµ„ä»¶æ¸¬è©¦** (ç›®æ¨™: 10 tests):
- PersonaList çµ„ä»¶ (3 tests)
  - è¼‰å…¥ç‹€æ…‹é¡¯ç¤º
  - æˆåŠŸé¡¯ç¤ºåˆ—è¡¨
  - éŒ¯èª¤è™•ç†
- PersonaCard çµ„ä»¶ (2 tests)
  - æ­£ç¢ºé¡¯ç¤º Persona è³‡è¨Š
  - é»æ“Šäº‹ä»¶è™•ç†
- PersonaBasicForm çµ„ä»¶ (5 tests)
  - è¡¨å–®é©—è­‰
  - æäº¤æˆåŠŸ/å¤±æ•—
  - Loading ç‹€æ…‹

**æ¸¬è©¦å·¥å…·**:
- Vitest - æ¸¬è©¦æ¡†æ¶
- React Testing Library - çµ„ä»¶æ¸¬è©¦
- MSW (Mock Service Worker) - API Mocking

**åƒè€ƒ**:
- ğŸ§ª [Component Testing Guidelines](../../docs/testing/testing-strategy.md#component-testing)
- ğŸ§ª [React Testing Library Best Practices](../../docs/testing/testing-strategy.md#rtl-best-practices)

**2. E2E æ¸¬è©¦** (ç›®æ¨™: 3 tests):
- Persona å‰µå»ºæµç¨‹ (1 test)
- Plugin ç†±é‡è¼‰æµç¨‹ (1 test)
- Persona é…ç½®è¼‰å…¥æµç¨‹ (1 test)

**æ¸¬è©¦å·¥å…·**:
- Playwright - E2E æ¸¬è©¦æ¡†æ¶

**åƒè€ƒ**:
- ğŸ§ª [E2E Testing Guidelines](../../docs/testing/testing-strategy.md#e2e-testing)

### éƒ¨ç½²èˆ‡ç›£æ§

**éƒ¨ç½²ç­–ç•¥å®Œæ•´æ–‡æª”**: [Deployment Strategy](../../docs/deployment/deployment-strategy.md)

#### Database Migration ç­–ç•¥

**Migration åŸ·è¡Œé †åº**:
```bash
# 1. å»ºç«‹ Migration
cd src/AIAgentPlatform.Infrastructure
dotnet ef migrations add AddPersonaAndPluginVersioning \
  --startup-project ../AIAgentPlatform.API

# 2. é©—è­‰ Migration SQL
dotnet ef migrations script \
  --startup-project ../AIAgentPlatform.API \
  --output migrations.sql

# 3. åŸ·è¡Œ Migration (Development)
dotnet ef database update \
  --startup-project ../AIAgentPlatform.API

# 4. åŸ·è¡Œ Migration (Production) - é€é CI/CD
# Migration æœƒåœ¨éƒ¨ç½²æ™‚è‡ªå‹•åŸ·è¡Œ
```

**Migration å…§å®¹**:
- æ–°å¢ `personas` è¡¨
- æ–°å¢ `persona_templates` è¡¨
- æ–°å¢ `prompt_templates` è¡¨
- æ–°å¢ `plugin_versions` è¡¨
- æ–°å¢ `plugin_version_history` è¡¨

**åƒè€ƒ**:
- ğŸ“¦ [Database Migration Strategy](../../docs/deployment/database-migrations.md)
- ğŸ“¦ [Zero-Downtime Deployment](../../docs/deployment/deployment-strategy.md#zero-downtime)

#### ç›£æ§èˆ‡æ—¥èªŒ

**ç›£æ§æŒ‡æ¨™**:
- Prompt ç”Ÿæˆå»¶é² (P50, P95, P99)
- Plugin ç†±é‡è¼‰æˆåŠŸç‡
- Persona API è«‹æ±‚æ•¸èˆ‡éŒ¯èª¤ç‡
- JSONB æŸ¥è©¢æ•ˆèƒ½

**æ—¥èªŒç­–ç•¥**:
- Structured Logging (Serilog)
- Log Level: Information (Production)
- é—œéµæ“ä½œæ—¥èªŒ: Plugin è¼‰å…¥/å¸è¼‰, Prompt ç”Ÿæˆ, Persona CRUD

**åƒè€ƒ**:
- ğŸ“Š [Monitoring Strategy](../../docs/deployment/monitoring-strategy.md)
- ğŸ“Š [Logging Best Practices](../../docs/deployment/logging-guidelines.md)

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šç·¨ç¢¼è¦ç¯„

**ç·¨ç¢¼è¦ç¯„å®Œæ•´æ–‡æª”**: [Coding Conventions](../../docs/development-standards/coding-conventions.md)

### Backend (.NET 9 / C#)

**Backend ç·¨ç¢¼æ¨™æº–**: [.NET Coding Standards](../../docs/development-standards/coding-conventions.md#dotnet)

#### å‘½åè¦ç¯„

**åƒè€ƒ**:
- ğŸ“ [Naming Conventions](../../docs/development-standards/coding-conventions.md#naming-conventions)
- ğŸ“ [C# Style Guide](../../docs/development-standards/coding-conventions.md#csharp-style)

**å‘½åè¦å‰‡**:
```csharp
// Pascal Case: Classes, Methods, Properties, Public Fields
public sealed class PersonaRepository : IPersonaRepository
{
    public async Task<Persona> GetByIdAsync(Guid id) { }
}

// Camel Case: Local variables, parameters, private fields
private readonly ILogger<PersonaService> _logger;
public async Task<Result> CreatePersonaAsync(string personaName) { }

// Interface: 'I' prefix
public interface IPromptGenerationService { }

// Constants: Pascal Case with descriptive names
public const int MaxPromptTokens = 4000;
public const string DefaultTemplateKey = "template_default";

// Async methods: 'Async' suffix
public async Task<Result<Persona>> LoadPersonaAsync(Guid id) { }
```

#### SOLID åŸå‰‡

**åƒè€ƒ**:
- ğŸ“ [SOLID Principles](../../docs/development-standards/code-quality-standards.md#solid-principles)
- ğŸ“ [Design Patterns](../../docs/development-standards/code-quality-standards.md#design-patterns)

**å¯¦è¸åŸå‰‡**:
1. **å–®ä¸€è·è²¬åŸå‰‡ (SRP)**:
   - `PromptGenerationService` åªè² è²¬ Prompt ç”Ÿæˆ
   - `PluginLoader` åªè² è²¬ Plugin è¼‰å…¥/å¸è¼‰
   - `PersonaRepository` åªè² è²¬ Persona è³‡æ–™å­˜å–

2. **é–‹æ”¾å°é–‰åŸå‰‡ (OCP)**:
   - ä½¿ç”¨ Interface å®šç¾©è¡Œç‚º (`IPluginLoader`, `IPromptGenerationService`)
   - é€é Strategy Pattern æ”¯æ´ä¸åŒ Template Engine (Liquid, Handlebars)

3. **é‡Œæ°æ›¿æ›åŸå‰‡ (LSP)**:
   - æ‰€æœ‰ Repository å¯¦ä½œå¿…é ˆéµå®ˆ `IRepository<T>` å¥‘ç´„
   - Mock ç‰©ä»¶å¯å®Œå…¨æ›¿æ›çœŸå¯¦å¯¦ä½œé€²è¡Œæ¸¬è©¦

4. **æ¥å£éš”é›¢åŸå‰‡ (ISP)**:
   - `IPluginLoader` èˆ‡ `IPluginActivator` åˆ†é›¢
   - `IPromptGenerationService` èˆ‡ `ITokenCounter` åˆ†é›¢

5. **ä¾è³´åè½‰åŸå‰‡ (DIP)**:
   - Application Layer ä¾è³´ Interface, ä¸ä¾è³´å…·é«”å¯¦ä½œ
   - ä½¿ç”¨ Dependency Injection Container ç®¡ç†ä¾è³´

#### Clean Architecture è¦ç¯„

**åƒè€ƒ**:
- ğŸ—ï¸ [ADR-001: Clean Architecture](../../docs/architecture/adr/ADR-001-clean-architecture.md)
- ğŸ—ï¸ [Dependency Rules](../../docs/architecture/adr/ADR-001-clean-architecture.md#dependency-rules)

**åˆ†å±¤ä¾è³´è¦å‰‡**:
```
API Layer (æœ€å¤–å±¤)
    â†“ ä¾è³´
Infrastructure Layer
    â†“ ä¾è³´
Application Layer
    â†“ ä¾è³´
Domain Layer (æ ¸å¿ƒ, ä¸ä¾è³´ä»»ä½•å¤–éƒ¨å±¤)
```

**é•åç¯„ä¾‹ (âŒ éŒ¯èª¤)**:
```csharp
// Domain Layer ä¸æ‡‰è©²ä¾è³´ Infrastructure
namespace AIAgentPlatform.Domain.Entities
{
    using AIAgentPlatform.Infrastructure.Persistence; // âŒ éŒ¯èª¤!
}
```

**æ­£ç¢ºç¯„ä¾‹ (âœ… æ­£ç¢º)**:
```csharp
// Domain Layer å®šç¾©æ¥å£
namespace AIAgentPlatform.Domain.Interfaces
{
    public interface IPersonaRepository { }
}

// Infrastructure Layer å¯¦ä½œæ¥å£
namespace AIAgentPlatform.Infrastructure.Repositories
{
    using AIAgentPlatform.Domain.Interfaces; // âœ… æ­£ç¢º
    public class PersonaRepository : IPersonaRepository { }
}
```

#### CQRS èˆ‡ MediatR è¦ç¯„

**åƒè€ƒ**:
- ğŸ“ [ADR-002: CQRS Pattern](../../docs/architecture/adr/ADR-002-cqrs-pattern.md)
- ğŸ“ [CQRS Implementation](../../docs/technical-implementation/01-backend-net9/05-cqrs-implementation.md)

**Command è¦ç¯„**:
```csharp
// 1. Command ä½¿ç”¨ record èªæ³• (immutable)
public sealed record CreatePersonaCommand(
    string Name,
    string Role,
    PersonaConfig Config) : IRequest<Result<PersonaDto>>;

// 2. Handler éµå¾ªå–®ä¸€è·è²¬
public sealed class CreatePersonaCommandHandler
    : IRequestHandler<CreatePersonaCommand, Result<PersonaDto>>
{
    private readonly IPersonaRepository _repository;
    private readonly IMapper _mapper;

    // 3. ä½¿ç”¨å»ºæ§‹å‡½æ•¸æ³¨å…¥ä¾è³´
    public CreatePersonaCommandHandler(
        IPersonaRepository repository,
        IMapper mapper)
    {
        _repository = repository;
        _mapper = mapper;
    }

    // 4. å›å‚³ Result Pattern (ä¸æ‹‹å‡ºç•°å¸¸)
    public async Task<Result<PersonaDto>> Handle(
        CreatePersonaCommand request,
        CancellationToken cancellationToken)
    {
        // Implementation
    }
}
```

**Query è¦ç¯„**:
```csharp
// Query ä½¿ç”¨ record èªæ³•
public sealed record GetPersonaByIdQuery(Guid PersonaId)
    : IRequest<Result<PersonaDto>>;

// Query Handler åªè®€æ“ä½œ
public sealed class GetPersonaByIdQueryHandler
    : IRequestHandler<GetPersonaByIdQuery, Result<PersonaDto>>
{
    // åªä¾è³´ Repository Query æ–¹æ³•
    public async Task<Result<PersonaDto>> Handle(
        GetPersonaByIdQuery request,
        CancellationToken cancellationToken)
    {
        // ä½¿ç”¨ AsNoTracking() æå‡æŸ¥è©¢æ•ˆèƒ½
        var persona = await _repository.GetByIdAsync(
            request.PersonaId,
            asNoTracking: true,
            cancellationToken);
    }
}
```

#### Code Quality æ¨™æº–

**åƒè€ƒ**:
- ğŸ“ [Code Quality Standards](../../docs/development-standards/code-quality-standards.md)
- ğŸ“ [Static Analysis Rules](../../docs/development-standards/code-quality-standards.md#static-analysis)

**éœæ…‹åˆ†æè¦å‰‡**:
```yaml
Cyclomatic Complexity:
  Maximum: 15
  Target: â‰¤10

Code Duplication:
  Maximum: 5%
  Target: <3%

Method Length:
  Maximum: 100 lines
  Target: â‰¤50 lines

Class Size:
  Maximum: 500 lines
  Target: â‰¤300 lines
```

**Code Smell åµæ¸¬**:
- Long Method (>100 lines)
- Large Class (>500 lines)
- Too Many Parameters (>5 parameters)
- Duplicate Code
- Dead Code

### Frontend (React 18 / TypeScript)

**Frontend ç·¨ç¢¼æ¨™æº–**: [React/TypeScript Coding Standards](../../docs/development-standards/coding-conventions.md#react-typescript)

#### å‘½åè¦ç¯„

**åƒè€ƒ**:
- ğŸ“ [React Naming Conventions](../../docs/development-standards/coding-conventions.md#react-naming)
- ğŸ“ [TypeScript Style Guide](../../docs/development-standards/coding-conventions.md#typescript-style)

**å‘½åè¦å‰‡**:
```typescript
// Pascal Case: Components, Types, Interfaces
export const PersonaList: React.FC = () => { };
export interface Persona { }
export type PersonaConfig = { };

// Camel Case: Functions, variables, props
const fetchPersonas = async () => { };
const personaList = usePersonas();
const handleSubmit = (data: FormData) => { };

// Component æª”æ¡ˆåç¨±èˆ‡çµ„ä»¶åç¨±ä¸€è‡´
// PersonaList.tsx exports PersonaList component

// Hooks: 'use' prefix
export const usePersonas = () => { };
export const useCreatePersona = () => { };
```

#### çµ„ä»¶è¨­è¨ˆåŸå‰‡

**åƒè€ƒ**:
- ğŸ¨ [Component Design Principles](../../docs/technical-implementation/02-frontend-react/02-component-design.md#design-principles)
- ğŸ¨ [TypeScript Best Practices](../../docs/development-standards/coding-conventions.md#typescript-best-practices)

**çµ„ä»¶è¦ç¯„**:
```typescript
// 1. ä½¿ç”¨ TypeScript å®šç¾© Props
interface PersonaCardProps {
  persona: Persona;
  onEdit?: (id: string) => void;
  onDelete?: (id: string) => void;
}

// 2. ä½¿ç”¨ React.FC æˆ– å‡½æ•¸çµ„ä»¶
export const PersonaCard: React.FC<PersonaCardProps> = ({
  persona,
  onEdit,
  onDelete,
}) => {
  // 3. ä½¿ç”¨ hooks ç®¡ç†ç‹€æ…‹
  const [isExpanded, setIsExpanded] = useState(false);

  // 4. ä½¿ç”¨ useCallback å„ªåŒ–å›èª¿å‡½æ•¸
  const handleExpand = useCallback(() => {
    setIsExpanded((prev) => !prev);
  }, []);

  // 5. ææ—©è¿”å› (Guard Clauses)
  if (!persona) return null;

  return (
    <div className="persona-card">
      {/* Component JSX */}
    </div>
  );
};
```

#### Hooks è¦ç¯„

**åƒè€ƒ**:
- ğŸ¨ [React Hooks Guidelines](../../docs/technical-implementation/02-frontend-react/01-frontend-architecture.md#hooks-guidelines)
- ğŸ¨ [Custom Hooks Best Practices](../../docs/technical-implementation/02-frontend-react/01-frontend-architecture.md#custom-hooks)

**Hooks ä½¿ç”¨è¦å‰‡**:
```typescript
// 1. è‡ªè¨‚ Hook ä»¥ 'use' é–‹é ­
export const usePersonas = () => {
  return useQuery({
    queryKey: ['personas'],
    queryFn: personaService.getAll,
  });
};

// 2. ä¸åœ¨æ¢ä»¶èªå¥ä¸­ä½¿ç”¨ Hooks (âŒ éŒ¯èª¤)
if (condition) {
  const data = usePersonas(); // âŒ éŒ¯èª¤!
}

// 3. æ­£ç¢ºç”¨æ³• (âœ… æ­£ç¢º)
const { data } = usePersonas();
if (condition && data) {
  // Use data
}

// 4. éµå¾ª React Hooks ä¾è³´è¦å‰‡
useEffect(() => {
  fetchPersonas();
}, [fetchPersonas]); // å¿…é ˆåˆ—å‡ºæ‰€æœ‰ä¾è³´
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šè³ªé‡ä¿è­‰

### Code Review

**Code Review å®Œæ•´æŒ‡å—**: [Code Review Checklist](../../docs/development-standards/code-review-checklist.md)

#### Code Review é‡é»

**åƒè€ƒ**:
- âœ… [Code Review Checklist](../../docs/development-standards/code-review-checklist.md)
- âœ… [Code Review Process](../../docs/development-standards/git-workflow.md#pull-request-process)

**Review Checklist**:
1. **åŠŸèƒ½æ­£ç¢ºæ€§**:
   - âœ… æ‰€æœ‰é©—æ”¶æ¨™æº–æ»¿è¶³
   - âœ… Edge Cases è™•ç†å®Œæ•´
   - âœ… éŒ¯èª¤è™•ç†é©ç•¶ (Result Pattern)

2. **æ¶æ§‹ä¸€è‡´æ€§**:
   - âœ… éµå¾ª Clean Architecture åˆ†å±¤
   - âœ… CQRS æ­£ç¢ºä½¿ç”¨
   - âœ… ä¾è³´æ³¨å…¥æ­£ç¢ºé…ç½®

3. **ä»£ç¢¼å¯è®€æ€§**:
   - âœ… å‘½åæ¸…æ™°æè¿°æ€§
   - âœ… æ–¹æ³•é•·åº¦é©ä¸­ (â‰¤50 lines)
   - âœ… è¨»è§£é©ç•¶ (Why, not What)

4. **æ¸¬è©¦è¦†è“‹ç‡**:
   - âœ… å–®å…ƒæ¸¬è©¦ â‰¥85%
   - âœ… é›†æˆæ¸¬è©¦è¦†è“‹é—œéµè·¯å¾‘
   - âœ… æ¸¬è©¦å¯è®€æ€§é«˜ (Arrange-Act-Assert)

5. **å®‰å…¨æ€§æª¢æŸ¥**:
   - âœ… ç„¡ SQL Injection é¢¨éšª
   - âœ… è¼¸å…¥é©—è­‰å®Œæ•´ (FluentValidation)
   - âœ… æ•æ„Ÿè³‡è¨Šä¸è¨˜éŒ„æ—¥èªŒ
   - âœ… JSONB è³‡æ–™é©—è­‰ (JSON Schema)

6. **æ•ˆèƒ½è€ƒé‡**:
   - âœ… æŸ¥è©¢ä½¿ç”¨ AsNoTracking() (Query)
   - âœ… Async/Await æ­£ç¢ºä½¿ç”¨
   - âœ… é¿å… N+1 æŸ¥è©¢å•é¡Œ

### Definition of Done

**å®Œæˆå®šç¾©æ–‡æª”**: [Definition of Done](../../docs/project-management/definition-of-done.md)

#### Sprint 4 Definition of Done

**åƒè€ƒ**:
- âœ… [Definition of Done](../../docs/project-management/definition-of-done.md)
- âœ… [Acceptance Criteria](../../docs/user-stories/modules/module-07-persona-framework.md#acceptance-criteria)

**é€šç”¨ DoD**:
- âœ… æ‰€æœ‰é©—æ”¶æ¨™æº–é€šé
- âœ… å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥ 85%
- âœ… é›†æˆæ¸¬è©¦é€šé (API ç«¯é»æ¸¬è©¦)
- âœ… Code Review é€šé (è‡³å°‘ 1 ä½ Reviewer æ‰¹å‡†)
- âœ… æ–‡æª”æ›´æ–°å®Œæˆ (API æ–‡æª”ã€README)
- âœ… éƒ¨ç½²åˆ° Development ç’°å¢ƒ
- âœ… ç„¡ Critical / High Priority Bugs

**US 7.1 - Persona Template Configuration**:
- âœ… Persona é…ç½®è¼‰å…¥å™¨å¯¦ä½œå®Œæˆ
- âœ… 10 ç¨®é è¨­ Persona æ¨¡æ¿å»ºç«‹ä¸¦é€šéé©—è­‰
- âœ… JSON Schema é©—è­‰æ¸¬è©¦é€šé (Valid/Invalid æƒ…å¢ƒ)
- âœ… `personas` èˆ‡ `persona_templates` è³‡æ–™è¡¨å»ºç«‹ (Migration æˆåŠŸ)
- âœ… CRUD API ç«¯é»æ¸¬è©¦é€šé (8 tests)
- âœ… å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥85% (Domain + Application + Infrastructure)
- âœ… Swagger æ–‡æª”è‡ªå‹•ç”Ÿæˆä¸¦æ­£ç¢º
- âœ… Code Review é€šé

**US 7.2 - Persona-Driven Prompt Engineering**:
- âœ… Prompt æ¨¡æ¿å¼•æ“å¯¦ä½œå®Œæˆ (Liquid Template Engine)
- âœ… Persona-Driven Prompt ç”Ÿæˆæ¸¬è©¦é€šé (10+ ç¨® Persona çµ„åˆ)
- âœ… Token Counting æº–ç¢ºæ€§é©—è­‰ (TikToken)
- âœ… å‹•æ…‹èª¿æ•´æ©Ÿåˆ¶é©—è­‰ (Token è¶…é™æ™‚æ™ºèƒ½æˆªæ–·)
- âœ… `prompt_templates` è³‡æ–™è¡¨å»ºç«‹ (Migration æˆåŠŸ)
- âœ… Prompt Generation API æ¸¬è©¦é€šé (5 tests)
- âœ… æ¨¡æ¿å¿«å–åŠŸèƒ½é©—è­‰ (Cache Hit/Miss)
- âœ… å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥85%
- âœ… æ•´åˆæ¸¬è©¦é€šé (End-to-End Prompt Generation)
- âœ… Code Review é€šé

**US 2.2 - Plugin Hot Reload**:
- âœ… `IPluginLoader` ä»‹é¢èˆ‡å¯¦ä½œå®Œæˆ
- âœ… AssemblyLoadContext éš”é›¢é©—è­‰ (å¤šç‰ˆæœ¬ä¸¦å­˜)
- âœ… ç†±é‡è¼‰åŠŸèƒ½æ¸¬è©¦é€šé (è¼‰å…¥ â†’ åˆ‡æ› â†’ å¸è¼‰)
- âœ… è¨˜æ†¶é«”æ´©æ¼æ¸¬è©¦é€šé (GC å›æ”¶é©—è­‰)
- âœ… ç‰ˆæœ¬åˆ‡æ›åŸå­æ€§é©—è­‰ (ç„¡ Race Condition)
- âœ… å›æ»¾æ©Ÿåˆ¶æ¸¬è©¦é€šé (å¤±æ•—è‡ªå‹•å›æ»¾)
- âœ… `plugin_versions` èˆ‡ `plugin_version_history` è³‡æ–™è¡¨å»ºç«‹
- âœ… Hot Reload API æ¸¬è©¦é€šé (5 tests)
- âœ… å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥85%
- âœ… Code Review é€šé

### æŠ€è¡“å‚µå‹™ç®¡ç†

**æŠ€è¡“å‚µå‹™ç®¡ç†æŒ‡å—**: [Technical Debt Management](../../docs/development-standards/technical-debt-management.md)

#### å·²çŸ¥æŠ€è¡“å‚µå‹™

**åƒè€ƒ**:
- ğŸ“ [Technical Debt Management](../../docs/development-standards/technical-debt-management.md)
- ğŸ“ [Continuous Improvement Log](../../4-changes/CONTINUOUS-IMPROVEMENT-LOG.md)

**Sprint 4 æŠ€è¡“å‚µå‹™æ¸…å–®**:
1. **Persona æ¨¡æ¿ A/B Testing æ”¯æ´** (Priority: Low):
   - æè¿°: ç›®å‰ Persona åªæ”¯æ´å–®ä¸€æ¨¡æ¿ï¼ŒPhase 2 éœ€æ”¯æ´ A/B Testing
   - å½±éŸ¿: ç„¡æ³•é€²è¡Œ Persona æ•ˆæœæ¯”è¼ƒèˆ‡å„ªåŒ–
   - è¦åŠƒ: Sprint 5 å¯¦ä½œ (US 8.1)

2. **Plugin ç‰ˆæœ¬ç›¸å®¹æ€§è‡ªå‹•æª¢æŸ¥** (Priority: Medium):
   - æè¿°: ç†±é‡è¼‰æ™‚æœªæª¢æŸ¥ API ç ´å£æ€§è®Šæ›´
   - å½±éŸ¿: å¯èƒ½å°è‡´ Runtime éŒ¯èª¤
   - è¦åŠƒ: Sprint 6 å¯¦ä½œ (US 9.2)

3. **Prompt ç”Ÿæˆæ•ˆèƒ½å„ªåŒ–** (Priority: Low):
   - æè¿°: é¦–æ¬¡ç”Ÿæˆ Prompt éœ€è§£ææ¨¡æ¿ï¼Œæ•ˆèƒ½è¼ƒä½
   - å½±éŸ¿: API å»¶é²ç´„ 50-100ms
   - ç·©è§£: å·²å¯¦ä½œæ¨¡æ¿å¿«å– (Cache Hit å»¶é² <5ms)
   - è¦åŠƒ: ç›£æ§å¾Œæ±ºå®šæ˜¯å¦éœ€é€²ä¸€æ­¥å„ªåŒ–

4. **Frontend Persona ç®¡ç† UI** (Priority: High):
   - æè¿°: Sprint 4 åªå¯¦ä½œåŸºç¤ API æ•´åˆï¼Œå®Œæ•´ UI å¾…å¯¦ä½œ
   - å½±éŸ¿: ä½¿ç”¨è€…ç„¡æ³•é€é UI ç®¡ç† Persona
   - è¦åŠƒ: Sprint 5 å¯¦ä½œ (US 8.1)

### é¢¨éšªç®¡ç†

**é¢¨éšªç™»è¨˜ç°¿**: [Risk Register](../../1-planning/RISK-REGISTER.md)

#### Sprint 4 é¢¨éšªé …ç›®

**åƒè€ƒ**:
- âš ï¸ [Risk Register](../../1-planning/RISK-REGISTER.md)
- âš ï¸ [Risk Mitigation Strategies](../../1-planning/RISK-REGISTER.md#mitigation-strategies)

**é—œéµé¢¨éšª**:
1. **AssemblyLoadContext è¨˜æ†¶é«”æ´©æ¼** (Likelihood: Medium, Impact: High):
   - ç·©è§£æªæ–½: å¯¦ä½œå®Œæ•´çš„å–®å…ƒæ¸¬è©¦èˆ‡è¨˜æ†¶é«”ç›£æ§
   - é©—è­‰æ–¹æ³•: ä½¿ç”¨ dotMemory é€²è¡Œ Memory Profiling
   - ç‹€æ…‹: âœ… å·²ç·©è§£ (æ¸¬è©¦é€šé)

2. **Liquid Template Engine å®‰å…¨æ€§** (Likelihood: Low, Impact: High):
   - ç·©è§£æªæ–½: é™åˆ¶æ¨¡æ¿å¯åŸ·è¡Œç¨‹å¼ç¢¼ï¼Œä½¿ç”¨å®‰å…¨æ¨¡å¼
   - é©—è­‰æ–¹æ³•: Security Code Review + Penetration Testing
   - ç‹€æ…‹: âœ… å·²ç·©è§£ (å®‰å…¨é™åˆ¶å·²å¯¦ä½œ)

3. **JSONB æŸ¥è©¢æ•ˆèƒ½** (Likelihood: Medium, Impact: Medium):
   - ç·©è§£æªæ–½: å»ºç«‹é©ç•¶ç´¢å¼•ï¼Œç›£æ§æŸ¥è©¢æ•ˆèƒ½
   - é©—è­‰æ–¹æ³•: Load Testing (1000+ Personas)
   - ç‹€æ…‹: â³ æŒçºŒç›£æ§

### è³ªé‡æŒ‡æ¨™

**è³ªé‡æŒ‡æ¨™è¿½è¹¤**:
```yaml
æ¸¬è©¦è¦†è“‹ç‡:
  å–®å…ƒæ¸¬è©¦: â‰¥85% (ç›®æ¨™)
  é›†æˆæ¸¬è©¦: â‰¥80% (ç›®æ¨™)
  E2E æ¸¬è©¦: é—œéµæµç¨‹è¦†è“‹

ç¨‹å¼ç¢¼å“è³ª:
  Cyclomatic Complexity: â‰¤15
  Code Duplication: <5%
  Code Smells: 0 Critical, â‰¤5 Major

æ•ˆèƒ½æŒ‡æ¨™:
  Prompt ç”Ÿæˆå»¶é²: P95 <200ms
  Plugin ç†±é‡è¼‰æ™‚é–“: <5s
  API å›æ‡‰æ™‚é–“: P95 <500ms
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šåƒè€ƒæ–‡æª”

### Planning
- [MVP Scope Definition](../../1-planning/MVP-SCOPE-DEFINITION.md)
- [Sprint Allocation Analysis](../../1-planning/SPRINT-ALLOCATION-ANALYSIS.md)
- [Development Strategy](../../1-planning/DEVELOPMENT-STRATEGY.md)

### User Stories
- [Module 07: Persona Framework](../../docs/user-stories/modules/module-07-persona-framework.md)
- [Module 02: Plugin System](../../docs/user-stories/modules/module-02-plugin-system.md)

### Technical Implementation
- [Persona Framework](../../docs/technical-implementation/01-backend-net9/03-persona-framework.md)
- [Prompt Engineering](../../docs/technical-implementation/01-backend-net9/09-prompt-engineering.md)
- [Plugin System MCP](../../docs/technical-implementation/01-backend-net9/04-plugin-system-mcp.md)

---

## ä½¿ç”¨æŒ‡å—

### ç›®æ¨™è®€è€…
- é–‹ç™¼åœ˜éšŠæˆå“¡
- Tech Lead
- QA Engineer

### ä½¿ç”¨æ–¹å¼
1. **é–‹ç™¼å‰**: é–±è®€æŠ€è¡“å¯¦æ–½æ–¹æ¡ˆ
2. **é–‹ç™¼ä¸­**: éµå¾ªç·¨ç¢¼è¦ç¯„
3. **å®Œæˆå¾Œ**: æª¢æŸ¥ Definition of Done

---

## ç‰ˆæœ¬æ­·å²

### v2.1 (2025-11-13)
- âœ… å»ºç«‹ Sprint 4 PLAN æ–‡ä»¶
- âœ… å®šç¾©æŠ€è¡“å¯¦æ–½æ–¹æ¡ˆ
- âœ… æ˜ç¢ºè³ªé‡æ¨™æº–

---

**æ–‡ä»¶ç‰ˆæœ¬**: v2.1
**æœ€å¾Œæ›´æ–°**: 2025-11-13
**ç¶­è­·è€…**: Sprint 4 é–‹ç™¼åœ˜éšŠ
